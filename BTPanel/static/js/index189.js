import{c as e,r as s,k as a,p as t,q as i,v as l,e as r,A as o,x as n,F as p,a_ as m,M as u,C as c,ai as d,aj as g,a9 as f,a7 as b}from"./base-lib.js?v=1756369731";import{o as v,j as _,K as y,M as j}from"./utils-lib.js?v=1756369731";import{getPermission as w,batchSetMysqlAuth as h,setPermission as P,setPgSqlAuth as x}from"./database.js?v=1756369731";import{i as q,h as V}from"./validator.js?v=1756369731";import{x as k}from"./useMethod4.js?v=1756369731";import{g as D}from"./useStore2.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";import"./column.js?v=1756369731";const I={class:"p-20px"},A=e({__name:"index",props:{compData:{default:()=>({type:"single",rowData:{},config:{}})}},setup(e,{expose:A}){const{refs:{tabActive:S},refreshTableList:B}=D(),M=e,{rowData:O,type:C}=M.compData,{enable:F,exclude:U,clearBatch:H}=M.compData.config,J=s(),K=a({permission:"",ip:""}),L={ip:[{required:!0,trigger:["blur","change"],message:"请输入IP地址"}]},N={pgsql:{option:[{label:"所有人",value:"0.0.0.0/0"},{label:"本地服务器",value:"127.0.0.1/32"}],placeholder:"填写格式如：192.168.69.11/24",getPermission:()=>{const e="0.0.0.0/0"!==O.listen_ip&&"127.0.0.1/32"!==O.listen_ip;K.ip=e?O.listen_ip:"",K.permission=e?"ip":O.listen_ip},setPermission:async()=>{const{permission:e,ip:s}=K,a={data_name:O.name,username:O.username,listen_ip:"ip"===e?s:e};return await y({loading:"正在修改权限，请稍后...",request:x({data:JSON.stringify(a)}),success:({data:e})=>{j.request({msg:e.msg||e.data,status:e.status})}})}},mysql:{option:[{label:"所有人",value:"%"},{label:"本地服务器",value:"127.0.0.1"}],placeholder:"如果要允许IP段访问，可以使用%作为通配符，如127.17.%.%，如需要填写多个IP，请换行填写，每行一个IP",getPermission:async()=>{const{msg:e,status:s}=await y({request:w({name:O.username}),data:{msg:String,status:Boolean}});if(!s)return j.error(e);K.permission=e,"%"!==e&&"127.0.0.1"!==e&&(K.permission="ip",K.ip=e.replace(/,/g,"\n"))},setPermission:async()=>{const e=(()=>{const{permission:e,ip:s}=K;let a={name:O.username,dataAccess:e,access:"ip"===e?s:e,address:"ip"===e?s:""};return"multlples"==C?(delete a.name,V(O,U,F,{params:{...a}})):a})();if("multlples"===C){const s=await h(e),{data:a}=q(s.data);return a.length&&k(a,{title:"修改权限"}),H&&H(),s}{const s=await y({loading:"正在修改权限，请稍后...",request:P(e),message:"single"===C,data:{error:[Object,e=>Object.keys(e)],success:Array,status:Boolean,msg:String}});return s.status?s:j.error(s.msg)}}}};return t(()=>{(async()=>{"multlples"!=C?N[S.value].getPermission():K.permission=N[S.value].option.filter(e=>e.label.includes("本地"))[0].value})()}),A({onConfirm:async e=>{await J.value.validate();const{permission:s,ip:a}=K;["%","0.0.0.0/0"].includes(s)&&await v({title:"提示",content:"设置权限为所有人后，将会导致数据库安全性降低，他人可以随意访问数据库，是否继续操作？",icon:"warning-filled"});(await N[S.value].setPermission()).status&&(e(),B())}}),(e,s)=>{const a=d,t=g,v=f,y=_,j=b;return i(),l("div",I,[r(j,{ref_key:"permissionFormRef",ref:J,model:n(K),rules:L,"label-width":"5rem"},{default:o(()=>[r(v,{label:"访问权限",prop:"permission"},{default:o(()=>[r(t,{class:"!w-[22rem]",modelValue:n(K).permission,"onUpdate:modelValue":s[0]||(s[0]=e=>n(K).permission=e)},{default:o(()=>[(i(!0),l(p,null,m(N[n(S)].option,e=>(i(),u(a,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128)),r(a,{label:"指定ip",value:"ip"})]),_:1},8,["modelValue"])]),_:1}),"ip"===n(K).permission?(i(),u(v,{key:0,prop:"ip",label:"IP地址"},{default:o(()=>[r(y,{type:"mysql"===n(S)?"textarea":"text",rows:4,width:"22rem",modelValue:n(K).ip,"onUpdate:modelValue":s[1]||(s[1]=e=>n(K).ip=e),placeholder:N[n(S)].placeholder},null,8,["type","modelValue","placeholder"])]),_:1})):c("",!0)]),_:1},8,["model"])])}}});export{A as default};
