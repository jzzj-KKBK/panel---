import{_ as a}from"./index116.js?v=1756369731";import{o as e,K as t,M as s,gC as l,S as o,J as n,k as i,W as r,j as m,h as d}from"./utils-lib.js?v=1756369731";import{c,r as p,k as u,aB as f,bP as g,p as v,G as w,q as h,v as x,e as y,A as _,y as b,B as k,x as q,C as j,H as V,Q as C,P as S,D as z,a$ as D,a9 as H,a7 as M}from"./base-lib.js?v=1756369731";import{_ as U}from"./index103.js?v=1756369731";import{_ as O}from"./index112.js?v=1756369731";import{restoreModuleBack as Y,restoreBack as A,getImportLog as F,getBackup as J,getModulesBackup as P}from"./database.js?v=1756369731";import{g as T}from"./useStore2.js?v=1756369731";import{h as B,u as N}from"./column.js?v=1756369731";import{f as G}from"./validator.js?v=1756369731";import{t as K,v as Q}from"./useMethod4.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";const R={class:"p-[20px]"},W={class:"flex items-center"},$={key:0,class:"ml-[1.2rem]"},E={class:"p-2rem flex flex-col"},I=c({__name:"import-back",props:{compData:{default:{}}},setup(c){const{refs:{tabActive:I}}=T(),L=c,X=p(0),Z=p([]),aa=p(!1),ea=p({}),ta=p(!1),sa=p(),la=u({password:""}),oa=p(!1),na=p(!1),ia=p(""),ra=[{content:"仅支持sql、zip、sql.gz、(tar.gz|gz|tgz)"},{content:"zip、tar.gz压缩包结构：test.zip或test.tar.gz压缩包内，必需包含test.sql"},{content:"若文件过大，您还可以使用SFTP工具，将数据库文件上传到您设置的默认备份目录"},{content:"若未设置默认备份目录，默认路径为/www/backup/database"}],ma=u({password:[{required:!0,message:"请输入压缩密码",trigger:"blur"}]}),da=u({p:1,limit:10,search:""}),ca=()=>{G({type:"file",path:"/www/backup",change:async a=>{pa({path:a})},confirmText:"导入"})},pa=async(a,s=!1)=>{ea.value=a,await e({title:"导入数据库",content:'<div class="text-[1.4rem] leading-2rem">【'.concat(L.compData.name,"】数据库将被覆盖，是否继续操作？</div>"),isHtml:!0,icon:"warning-filled",type:"calc"});let l={file:a.path,name:L.compData.name};"mysql"===I.value?(s&&(l.disk_check=!0),ua(l,()=>pa(a,!0))):await t({request:Y({data:JSON.stringify(l)},I.value),loading:"正在导入数据库,请稍后...",message:!0})},ua=async(a,e)=>{var s;const l=K({type:"import",config:{name:L.compData.name}}),o=await l,n=await t({request:A(a),message:!0});return"请您输入密码"===n.msg?(null==o||o.unmount(),void(ta.value=!0)):-1!==(null==(s=n.msg)?void 0:s.indexOf("警告"))?(await fa(n.msg),void e()):void(null==o||o.unmount())},fa=a=>e({title:"提示",isHtml:!0,width:"50rem",iconColor:"error",confirmText:"继续导入",content:'<div class="flex"><div><div>'.concat(a,"</div><div>\n\t\t\t<p>如继续导入可能会有以下影响：</p>\n\t\t\t<p>1.导入数据不完整</p>\n\t\t\t<p>2.系统运行缓慢</p>\n\t\t\t<p>3.面板无法正常工作</p>\n\t\t\t<p>4.mysql无法正常运行</p></div></div></div>")}),ga=async(a=!1)=>{await sa.value.validate();let e={file:ea.value.path,name:L.compData.name,password:la.password};a&&(e.disk_check=!0),ua(e,()=>ga(!0))},va=()=>{oa.value=!0,wa()},wa=async a=>{var e;-1!==(null==(e=(await t({loading:na,request:F(),data:{msg:[String,ia]}})).msg)?void 0:e.indexOf("Database recovery successful"))&&s.success("导入已完成"),a&&s.success("刷新成功")},ha=()=>{Q(()=>xa())},xa=async()=>{await t({loading:aa,request:"mysql"===I.value?J({...da}):P({data:JSON.stringify({...da})},I.value),data:{data:[Array,Z],page:o(X)}})},ya=[{label:"文件名",prop:"name"},{label:"修改时间",width:200,render:a=>{const e=new Date(Math.floor(1e3*a.mtime));return f("span",g(e,"YYYY-MM-DD HH:mm:ss"))}},B({prop:"size",width:100}),N([{onClick:a=>pa(a),title:"导入"},{onClick:a=>(async a=>{await e({title:"删除文件",content:"删除文件【".concat(a.name,"】后，该数据库文件将迁至回收站，是否继续操作？"),icon:"warning-filled"}),await t({request:l({path:a.path}),loading:"正在删除文件，请稍后...",message:!0}),xa()})(a),title:"删除"}])];return v(()=>{xa(),(async()=>{const a=await t({request:F(),data:{db_name:String}});(null==a?void 0:a.db_name)&&K({type:"import",config:{name:null==a?void 0:a.db_name}})})()}),(e,t)=>{const s=z,l=D,o=n,c=i,p=O,u=U,f=r,g=m,v=H,Y=M,A=d,F=a,J=w("bt-loading"),P=w("focus");return h(),x("div",R,[y(u,null,{"header-left":_(()=>[b("div",W,[y(s,{onClick:ha},{default:_(()=>[...t[8]||(t[8]=[k("从本地上传",-1)])]),_:1}),"mysql"===q(I)?(h(),x("div",$,[y(s,{onClick:ca},{default:_(()=>[...t[9]||(t[9]=[k("从本机导入",-1)])]),_:1}),y(l,{direction:"vertical",class:"!h-2rem !mx-1.2rem"}),y(s,{onClick:va},{default:_(()=>[...t[10]||(t[10]=[k("显示日志",-1)])]),_:1})])):j("",!0)])]),"header-right":_(()=>[y(o,{modelValue:q(da).search,"onUpdate:modelValue":t[0]||(t[0]=a=>q(da).search=a),placeholder:"请输入搜索关键字",onSearch:xa},null,8,["modelValue"])]),content:_(()=>[V(y(c,{column:ya,data:q(Z),"max-height":"360"},null,8,["data"]),[[J,q(aa)]])]),"footer-right":_(()=>[y(p,{total:q(X),page:q(da).p,"onUpdate:page":t[1]||(t[1]=a=>q(da).p=a),row:q(da).limit,"onUpdate:row":t[2]||(t[2]=a=>q(da).limit=a),onChange:xa},null,8,["total","page","row"])]),_:1}),y(f,{options:ra,class:"ml-[20px] mt-[20px]"}),y(A,{title:"导入数据库",modelValue:q(ta),"onUpdate:modelValue":t[5]||(t[5]=a=>S(ta)?ta.value=a:null),area:40,showFooter:"",onConfirm:ga},{default:_(()=>[y(Y,{model:q(la),ref_key:"inputMysqlForm",ref:sa,class:"p-[20px]",rules:q(ma),onSubmit:t[4]||(t[4]=C(()=>{},["prevent"]))},{default:_(()=>[t[11]||(t[11]=b("div",{class:"flex items-center mt-[1rem] mb-[2rem]"},[b("i",{class:"el-icon-warning text-[4rem] text-warning"}),b("div",{class:"ml-[1rem] text-[1.6rem] leading-[2.2rem] text-[#666]"},"当前文件存在压缩密码，请输入压缩密码进行导入")],-1)),y(v,{label:"压缩密码",prop:"password"},{default:_(()=>[V(y(g,{placeholder:"如未设置压缩密码，可为空",modelValue:q(la).password,"onUpdate:modelValue":t[3]||(t[3]=a=>q(la).password=a)},null,8,["modelValue"]),[[P]])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"]),y(A,{title:"显示日志",modelValue:q(oa),"onUpdate:modelValue":t[7]||(t[7]=a=>S(oa)?oa.value=a:null),area:70},{default:_(()=>[V((h(),x("div",E,[b("div",null,[y(s,{onClick:t[6]||(t[6]=a=>wa(!0)),type:"default",class:"!mb-1rem"},{default:_(()=>[...t[12]||(t[12]=[k("刷新日志",-1)])]),_:1})]),y(F,{class:"h-41rem",content:q(ia),isHtml:!0,fullScreen:{title:"全屏查看【数据库导入】日志",onRefresh:wa}},null,8,["content","fullScreen"])])),[[J,q(na)]])]),_:1},8,["modelValue"])])}}});export{I as default};
