var e=Object.defineProperty,t=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s);import{v as i,k as s,e as a,bU as l,Y as o,a4 as r,l as d,b as n,ai as u,o as p,c}from"./utils-lib.js?v=1756369731";import{c as h,r as m,q as f,v as g,y as v,e as S,x as T,J as z,n as L,k as F,g as w,p as b,aD as y,H as x,I,F as _,A as U,B as k,C as E,z as N,K as C,M as D,ap as j,ao as P,an as R,D as G,aQ as M}from"./base-lib.js?v=1756369731";import{_ as B}from"./index104.js?v=1756369731";import{s as O}from"./vue-virtual-scroller.esm.js?v=1756369731";import{F as q}from"./store.js?v=1756369731";import{an as A}from"./files.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./validator.js?v=1756369731";import"./column.js?v=1756369731";import"./store2.js?v=1756369731";import"./index101.js?v=1756369731";const H={class:""},K=a(h({__name:"file-cover-confirm",props:{compData:{default:()=>{}}},setup(e,{expose:t}){const a=e,l=m([{label:"文件名",prop:"name"},{label:"文件差异(本地->线上)",render:e=>"".concat(i(e.locaSize)," -> ").concat(i(e.size))}]);return t({onConfirm:e=>(a.compData.confirm(e,!0),!1),onCancel:e=>(a.compData.cancel(e,!1),!1)}),(e,t)=>{const i=s;return f(),g("div",{class:z(["confirm-default","text-dark relative p-2rem"])},[t[0]||(t[0]=v("div",{class:"content flex items-center mb-[10px]"},[v("i",{class:"svgtofont-el-warning text-[4rem] text-[#f0ad4e]"}),v("div",{class:"message flex flex-col flex-1 ml-4 py-[.3rem] leading-[2.4rem] text-[1.3rem]"},[v("div",{class:"text text-[1.4rem] text-[#666] leading-[2.5rem]"},"检测到上传目录包含重复文件，是否覆盖？")])],-1)),v("div",H,[S(i,{column:T(l),data:a.compData.data,"max-height":170},null,8,["column","data"])])])}}}),[["__scopeId","data-v-fdfa0e69"]]),{refreshFilesList:X}=q(),J=n();class Q{constructor(e){t(this,"target",""),t(this,"uploadPath",""),t(this,"uploadElement",null),t(this,"loading",{close:()=>{}}),t(this,"isUpload",!0),t(this,"isGetFiles",!1),t(this,"readFileTimeout",0),t(this,"limit",{size:32212254720,number:1e3}),t(this,"uploadStatus","paused"),t(this,"uploadLimitSize",2097152),t(this,"uploadList",[]),t(this,"uploadTime",{endTime:0,startTime:0}),t(this,"uploadInfo",{estimatedTime:0,uploadedSize:0,speedInterval:null,speedAverage:0,uploadTime:0,fileSize:0,startTime:0,endTime:0,success:0,error:0}),t(this,"fileList",[]),t(this,"fileTotalSize",0),t(this,"fileTotalNumber",0),t(this,"uploadInterval",0),t(this,"uploadCycleSize",[]),t(this,"speedLastTime",0),t(this,"timerSpeed",0),t(this,"uploadError",0),t(this,"isOpenCoverLayer",0),t(this,"uploadedFiles",[]),t(this,"initData",(e=!1)=>{this.uploadStatus="paused",this.uploadList=[],this.isUpload=!0,this.uploadTime={endTime:0,startTime:0},this.isGetFiles=!1,this.uploadInfo={estimatedTime:0,uploadedSize:0,speedInterval:null,speedAverage:0,uploadTime:0,fileSize:0,startTime:0,endTime:0,success:0,error:0},this.fileList=[],this.fileTotalSize=0,this.fileTotalNumber=0,this.uploadInterval=0,this.uploadCycleSize=[],this.speedLastTime=0,this.timerSpeed=0,e&&this.watchFileUploadStatus({status:"paused",timeElapsed:0,averageSpeed:0,uploadSize:"0B",successNumber:0,errorNumber:0})}),t(this,"watchFileList",e=>e),t(this,"watchFileUploadSpeed",e=>e),t(this,"watchFileUploadStatus",e=>e),t(this,"fileUploadLimit",(e,t)=>{const s=t;if(!this.isGetFiles)return!1;const a=e.name.split("."),o=(t=t||e.webkitRelativePath).split("/");t="/".concat(o.slice(0,o.length-1).join("/")).replace("//","/");let r=!1;return this.fileList.forEach((t,a)=>{if(t.path+t.name==s&&t.size==i(e.size))return J.error("该文件已存在"),r=!0}),!!r||(this.fileList=this.fileList.filter((e,t)=>e.path+e.name!==s),this.fileList.push({vid:l(8),file:e,path:t,name:e.name,size:i(e.size),type:a.length>1?a[a.length-1]:"txt",status:"paused",progress:0}),this.watchFileList(this.fileList),this.fileTotalSize+=e.size,this.fileTotalNumber++,this.fileTotalNumber>=this.limit.number?(J.error("当前文件数量已超过文件上传上限".concat(this.limit.number,"个， 请压缩文件夹后重试！")),!1):!(this.fileTotalSize>=this.limit.size)||(J.error("当前文件大小已超过文件上传".concat(i(this.limit.size),"限制， 请使用SFTP/FTP等工具上传文件！")),!1))}),t(this,"uploadFile",(e=0,t=0)=>0!==this.fileList.length&&(0==e&&0==this.uploadList.length&&(this.isOpenCoverLayer=0,this.uploadStatus="uploading",this.uploadedFiles=[],this.uploadCycleSize=[],this.uploadTime.startTime=this.getTimeReal()),this.fileList.length===t?(clearTimeout(this.uploadInterval),this.uploadStatus="success",this.uploadTime.endTime=this.getTimeReal(),this.renderUploadSpeed(),this.initData(),X(),!1):void this.uploadFileItem(e,t))),t(this,"uploadFileItem",async(e,t)=>{let i=this.fileList[t],s=0;if(null==i)return!1;const{uploadedSize:a}=this.uploadInfo;this.uploadInterval=setInterval(()=>{4===this.uploadCycleSize.length&&this.uploadCycleSize.splice(0,1),this.uploadCycleSize.push(Math.abs(this.uploadInfo.uploadedSize-a))},1e3),this.uploadInfo.endTime=this.getTimeReal();const l=(this.uploadInfo.endTime-this.uploadInfo.startTime)/1e3;this.timerSpeed=Number((this.uploadInfo.fileSize/l).toFixed(2)),this.uploadInfo.startTime=this.getTimeReal();const d=this.getUpdateSpeed();let n=this.uploadLimitSize;const u=Math.floor(d/this.uploadLimitSize);u&&t>1&&(n*=u>4?4:u),0==e&&(this.uploadInfo.startTime=this.getTimeReal(),i={...i,progress:0,upload:2,upload_size:"0B"}),s=Math.min(i.file.size,e+n),this.uploadInfo.fileSize=s-e;const p=this.uploadPath+i.path,c=new FormData;o(),c.append("f_path",p),c.append("f_name",i.name),c.append("f_size",i.file.size),c.append("f_start",e.toString()),c.append("blob",i.file.slice(e,s));try{const{data:a}=await r({method:"post",url:""+this.target,headers:{"x-http-token":window.vite_public_request_token},data:c});await this.watchUploadStatus(a,i,t,{fileStart:e,fileEnd:s})}catch(h){}}),t(this,"fileSelectHandler",(e,t)=>{var i,s;if(this.readFileTimeout=0,this.isGetFiles=!0,this.loading=J.load("正在获取上传文件，请稍候..."),null==(i=e.target)?void 0:i.files){const i=null==(s=e.target)?void 0:s.files;[].forEach.call(i,e=>{this.traverseFileTree(e,t)})}else if(e.dataTransfer.items){const{items:i}=e.dataTransfer;[].forEach.call(i,e=>{const i=(e.webkitGetAsEntry||e.getAsEntry).call(e);if(i){if(!this.isUpload)return!1;this.traverseFileTree(i,t)}})}}),t(this,"traverseFileTree",(e,t)=>{const i=e.fullPath||"";if(e.isFile)e.file(e=>{this.isGetFiles=this.fileUploadLimit(e,i),clearTimeout(this.readFileTimeout),this.readFileTimeout=setTimeout(()=>{if(this.loading.close(),!this.isGetFiles)return this.clearUploadFileList(),this.watchFileList(this.fileList),!1;t&&t(this.fileList)},100)});else if(e.isDirectory){const i=e.createReader(),s=e=>{[].forEach.call(e,e=>{if(!this.isUpload)return!1;this.traverseFileTree(e,t)}),e.length>0&&i.readEntries(s)};i.readEntries(s),setTimeout(()=>{if(0===this.fileList.length&&this.isGetFiles)return J.error("拖拽上传文件夹内容为空")},500)}}),t(this,"watchUploadStatus",(e,t,s,a)=>{"number"==typeof e?(this.renderUploadSpeed(s,{...t,progress:(e/t.file.size*100).toFixed(2),upload:2,upload_size:i(e)}),a.fileEnd!=e?this.uploadInfo.uploadedSize+=e:this.uploadInfo.uploadedSize+=parseInt((a.fileEnd-a.fileStart).toString()),setTimeout(()=>{this.uploadFile(e,s)},50)):(e.status?(this.uploadInfo.success++,this.uploadInfo.endTime=this.getTimeReal(),this.uploadInfo.uploadedSize+=parseInt((a.fileEnd-a.fileStart).toString()),this.renderUploadSpeed(s,{...t,upload:1,upload_size:t.size})):(this.renderUploadSpeed(s,{...t,progress:100,upload:-1,errorMsg:e.msg}),this.uploadInfo.error++),this.uploadFile(0,++s))}),t(this,"getUpdateSpeed",()=>{let e=0;for(let i=0;i<this.uploadCycleSize.length;i++)e+=this.uploadCycleSize[i];const t=e/this.uploadCycleSize.length;return isNaN(t)?0:t}),t(this,"renderUploadSpeed",(e,t)=>{if(void 0===e){const e=this.getTimeReal();return void this.watchFileUploadStatus({status:"success",timeElapsed:this.diffTime(this.uploadTime.startTime,e),averageSpeed:this.toSize(this.uploadInfo.uploadedSize/((e-this.uploadTime.startTime)/1e3)),uploadSize:i(this.uploadInfo.uploadedSize),successNumber:this.uploadInfo.success,errorNumber:this.uploadInfo.error})}try{const s=this.fileList[e];if(1===t.upload||-1===t.upload){s.is_upload=!0,this.uploadList.push(s);const e=document.querySelector(".file-upload-list");e&&(1===this.uploadList.length&&(e.scrollTop=0),this.uploadList.length>1&&(e.scrollTop+=45.5))}s.progress=t.progress,s.status=this.isUploadStatus(t.upload),s.message=t.errorMsg||"",this.watchFileList(this.fileList),this.watchFileUploadSpeed({totalProgress:(this.uploadInfo.uploadedSize/this.fileTotalSize*100).toFixed(2),currentSpeed:i(isNaN(this.timerSpeed)?0:this.timerSpeed),timeRemaining:this.time(parseInt(((this.fileTotalSize-this.uploadInfo.uploadedSize)/this.timerSpeed*1e3).toString())),uploadList:this.uploadList.length})}catch(s){}}),t(this,"getFileName",e=>"".concat(e.path,"/").concat(e.name).replace(/\/\//,"/")),t(this,"useFileUploadExistsConfirm",async()=>{const e=this.fileList.map(e=>this.uploadPath+this.getFileName(e)),{data:t}=await A({files:e.join("\n")});if(!t)return;const i=[];if(this.fileList.forEach((e,s)=>{const a=t[s];a.exists&&i.push({name:this.getFileName(e),size:a.size,locaSize:e.file.size})}),i.length){const e=(e,t)=>{if(!t)for(let s=this.fileList.length-1;s>=0;s--){const e=this.fileList[s];i.findIndex(t=>t.name.indexOf(e.name)>-1)>=0&&this.fileList.splice(s,1)}L(()=>{e(),this.fileList.length?this.uploadFile():this.clearUploadFileList()})};await d({title:"文件冲突确认",area:40,component:K,compData:{data:i,confirm:e,cancel:e},showFooter:!0,cancelText:"跳过",confirmText:"覆盖"})}else this.fileList.length&&this.uploadFile()}),t(this,"cancelFile",e=>{const t=this.fileList.filter((t,i)=>t.vid!==e.vid);this.fileList=t,this.watchFileList(this.fileList),0===this.fileList.length&&this.clearUploadFileList()}),t(this,"toSize",e=>{const t=[" B"," KB"," MB"," GB"," TB"," PB"];for(let i=0;i<t.length;i+=1){if(e<1024){const s=e.toFixed(2)+t[i];return isNaN(e.toFixed(2))||void 0===s?"0B":s}e/=1024}}),t(this,"time",e=>{const t=Math.floor(e/36e5),i=Math.floor(e/6e4),s=e%6e4/1e3;let a="".concat(s,"秒");return i>0&&(a="".concat(i,"分钟").concat(s.toFixed(0),"秒")),t>0&&(a="".concat(t,"小时").concat(Math.floor((e-36e5*t)/6e4),"分钟")),a}),this.target=e.target,this.uploadPath=e.uploadPath,this.watchFileList=e.renewalData,this.watchFileUploadSpeed=e.renewalSpeed,this.watchFileUploadStatus=e.renewalStatus,this.initData()}uploadStatusInfo(e){return{success:"上传成功",error:"上传失败",uploading:"上传中",paused:"等待上传",waiting:"等待上传"}[e]}isUploadStatus(e){return{"-1":"error",0:"paused",1:"success",2:"uploading",3:"waiting"}[e]}getTimeReal(){return(new Date).getTime()}clearUploadFileList(){this.initData(!0),this.watchFileList(this.fileList)}diffTime(e,t){"number"!=typeof e&&(e=e.getTime()),"number"!=typeof t&&(t=t.getTime());const i=t-e,s=Math.floor(i/6e4),a=i%6e4/1e3;let l="".concat(a.toFixed(s>0?0:2),"秒");return s>0&&(l="".concat(s,"分").concat(a.toFixed(0),"秒")),l}}const Y=e=>{e.preventDefault()},V=e=>{const t=document.querySelector("#upload-mask");return window.addEventListener("dragenter",t=>{Y(t),e.dragenter(t)}),null==t||t.addEventListener("dragenter",t=>{Y(t),e.dragenter(t)}),null==t||t.addEventListener("dragleave",t=>{Y(t),e.dragleave(t)}),null==t||t.addEventListener("dragover",t=>{Y(t),e.dragover(t)}),null==t||t.addEventListener("drop",t=>{Y(t),e.drop(t)}),e},W={id:"upload-mask"},Z={class:"p-[20px]"},$=["webkitdirectory"],ee={class:"mb-[16px] flex justify-between"},te={key:1,class:"upload-press"},ie={key:2,class:"upload-press"},se={key:3,class:"upload-files-tips"},ae={key:4,class:"uploader-list"},le={class:"th"},oe={class:"td justify-end"},re={class:"uploader-file tr"},de={class:"td-block"},ne={class:"td !w-[55%] flex"},ue=["title"],pe={class:"td"},ce={class:"td"},he={class:"truncate"},me={key:0},fe={class:"td justify-end"},ge={class:"flex justify-end"},ve=a(h({__name:"index",props:{compData:{default:()=>({path:""})}},setup(e,{expose:t}){const i=e,s=n(),{refreshFilesList:a}=q();let l=null;const o=m(),r=m(!1),d=m("paused"),h=m([]),L=m(),A=m(!1),H=F({totalProgress:0,uploadList:0,sizeUploaded:0,currentSpeed:0,timeRemaining:0,timeElapsed:0,averageSpeed:0,errorNumber:0,successNumber:0,uploadSize:""}),K=new Q({target:"/files?action=upload",uploadPath:i.compData.path||"/www/wwwroot",renewalData:e=>{h.value=[...e]},renewalSpeed:e=>{H.totalProgress=e.totalProgress,H.uploadList=e.uploadList,H.sizeUploaded=e.sizeUploaded,H.currentSpeed=e.currentSpeed,H.timeRemaining=e.timeRemaining},renewalStatus:e=>{d.value=e.status,H.timeElapsed=e.timeElapsed,H.averageSpeed=e.averageSpeed,H.uploadSize=e.uploadSize,H.successNumber=e.successNumber,H.errorNumber=e.errorNumber}}),{uploadStatusInfo:X,initData:J,fileUploadLimit:Y,cancelFile:ve}=K,Se=w(()=>!h.value.length),Te=w(()=>!h.value.length),ze=e=>(e.path+"/"+e.name).replace(/\/\//,"/"),Le=e=>{if(e.isFolder)return"folder";const t=e.name.split(".").pop();return["zip","rar","gz","tar","war","tgz","bz2","7z","tar.gz"].includes(t)?"compress":t},Fe=e=>{K.isGetFiles=!0,"file"!==e&&u(e)?A.value=!0:A.value=!1,setTimeout(()=>{L.value.click()},0)},we=e=>{const t=e.target.files;for(let s=0;s<t.length;s++){var i="/".concat(""==t[s].webkitRelativePath?t[s].name:t[s].webkitRelativePath);if(!Y(t[s],i))return!1}if(!K.isGetFiles)return!1},be=e=>"success"===e.status?{transform:"translateX(-0%)"}:{transform:"translateX(-".concat(100-e.progress,"%)")},ye=()=>{if(0===h.value.length)return s.error("请添加需要上传的文件");d.value="uploading",K.useFileUploadExistsConfirm()},xe=()=>{J(),h.value=[],d.value="paused"},Ie=()=>{r.value=!0,"success"===d.value&&xe()},_e=()=>{r.value=!1},Ue=e=>{r.value=!1,K.fileSelectHandler(e,e=>{h.value=e||[]})};return b(()=>{l={...V({dragenter:Ie,dragleave:_e,drop:Ue,dragover:()=>{}})}}),y(()=>{(e=>{const t=document.querySelector("#upload-mask");window.removeEventListener("dragenter",e.dragenter),null==t||t.removeEventListener("dragenter",e.dragenter),null==t||t.removeEventListener("dragover",e.dragover),null==t||t.removeEventListener("dragleave",e.dragleave),null==t||t.removeEventListener("drop",e.drop)})(l)}),t({onCancel:async()=>{try{if(["uploading","paused"].includes(d.value)&&h.value.length)return await p({title:"取消上传",width:"35rem",icon:"warning-filled",content:"是否取消上传，取消后将清空上传列表？"}),a(),!0}catch(e){return!1}}}),(e,t)=>{const i=j,s=P,a=R,l=G,n=B,u=M,p=c;return f(),g("div",{class:"upload-file-view",ref_key:"upload",ref:o},[x(v("div",W,"请将需要上传的文件/文件夹拖到此处",512),[[I,T(r)]]),v("div",Z,[T(d).indexOf("paused")>-1?(f(),g(_,{key:0},[v("input",{type:"file",ref_key:"uploadFileInput",ref:L,webkitdirectory:T(A),onChange:we,style:{display:"none"},multiple:""},null,40,$),v("div",ee,[S(a,{"split-button":"",type:"default","show-timeout":50,"hide-timeout":50,onClick:Fe,onCommand:Fe},{dropdown:U(()=>[S(s,{class:"w-[10rem]"},{default:U(()=>[S(i,{command:"file"},{default:U(()=>[...t[0]||(t[0]=[k("上传文件",-1)])]),_:1}),S(i,{command:"dir"},{default:U(()=>[...t[1]||(t[1]=[k("上传文件夹",-1)])]),_:1})]),_:1})]),default:U(()=>[t[2]||(t[2]=k(" 上传文件 ",-1))]),_:1}),S(l,{onClick:xe,disabled:T(Se)},{default:U(()=>[...t[3]||(t[3]=[k("清空列表",-1)])]),_:1},8,["disabled"])])],64)):E("",!0),T(d).indexOf("uploading")>-1?(f(),g("div",te,[v("span",null,"总进度："+N(T(H).totalProgress)+"%",1),S(n),v("span",null,"正在上传：("+N("".concat(T(H).uploadList,"/").concat(T(h).length))+")",1),S(n),v("span",null,"上传速度："+N(T(H).currentSpeed)+"/s",1),S(n),v("span",null,"预计耗时："+N(T(H).timeRemaining),1)])):E("",!0),T(d).indexOf("success")>-1?(f(),g("div",ie,[v("span",null,"上传大小："+N(T(H).uploadSize),1),S(n),v("span",null,"共耗时："+N(T(H).timeElapsed),1),S(n),v("span",null,"平均上传速度："+N(T(H).averageSpeed)+"/s",1),S(n),v("span",null,"上传成功："+N(T(H).successNumber)+"个",1),x(S(n,null,null,512),[[I,T(H).errorNumber>0]]),x(v("span",null,"上传失败："+N(T(H).errorNumber)+"个",513),[[I,T(H).errorNumber>0]])])):E("",!0),T(Te)?(f(),g("div",se,[...t[4]||(t[4]=[v("span",null,"请将需要上传的文件/文件夹拖到此处",-1)])])):(f(),g("div",ae,[v("div",le,[t[5]||(t[5]=v("div",{class:"td !w-[55%]"},"文件名",-1)),t[6]||(t[6]=v("div",{class:"td"},"文件大小",-1)),t[7]||(t[7]=v("div",{class:"td"},"上传状态",-1)),x(v("div",oe,"操作",512),[[I,"success"!==T(d)]])]),v("div",null,[S(T(O),{class:z(["!mb-0 overflow-auto file-upload-list files-list","!h-[400px]"]),items:T(h),"item-size":45,buffer:800,"key-field":"vid"},{default:U(({item:e})=>[v("div",re,[v("div",{class:z({"td-progress":!0,error:"error"===e.status,success:"success"===e.status}),style:C(be(e))},null,6),v("div",de,[v("div",ne,[v("i",{class:z(["icon-bg","".concat(Le(e),"-icon")])},null,2),v("span",{class:"flex-1 w-0 ml-[4px] truncate h-[20px] leading-[20px]",title:ze(e)},N(ze(e)),9,ue)]),v("div",pe,N(e.size),1),v("div",ce,[x(S(u,{effect:"dark",content:"".concat(T(X)(e.status)).concat(e.message?"，".concat(e.message):""),placement:"right","show-after":200},{default:U(()=>[x(v("span",he,[k(N(T(X)(e.status))+" ",1),e.message?(f(),g("span",me," ,"+N(e.message),1)):E("",!0)],512),[[I,"uploading"!==e.status]])]),_:2},1032,["content"]),[[I,"uploading"!==e.status]]),x(v("span",null,[v("span",null,"上传中("+N(parseInt(e.progress))+"%)",1)],512),[[I,"uploading"===e.status]])]),x(v("div",fe,[x(S(p,{onClick:t=>T(ve)(e)},{default:U(()=>[...t[8]||(t[8]=[k("取消",-1)])]),_:2},1032,["onClick"]),[[I,T(d).indexOf("paused")>-1]])],512),[[I,"success"!==T(d)]])])])]),_:1},8,["items"])])])),v("div",ge,[T(d).indexOf("paused")>-1?(f(),D(l,{key:0,type:"primary",onClick:ye},{default:U(()=>[...t[9]||(t[9]=[k(" 开始上传 ",-1)])]),_:1})):E("",!0),["success","error"].includes(T(d))?(f(),D(l,{key:1,type:"primary",onClick:xe},{default:U(()=>[...t[10]||(t[10]=[k(" 继续上传 ",-1)])]),_:1})):E("",!0)])])],512)}}}),[["__scopeId","data-v-f0d14467"]]);export{ve as default};
