import{_ as e}from"./index103.js?v=1756369731";import{o as a,K as t,M as l,at as o,k as r,j as n,ag as s,W as u,h as i,e as p}from"./utils-lib.js?v=1756369731";import{c as m,r as d,ar as c,k as h,g as w,p as y,G as b,q as f,v,e as g,A as _,y as k,x as V,P as x,B as N,H as I,M as D,F as T,a_ as S,C as E,U as j,al as U,D as H,a9 as M,ai as C,aj as q,a7 as F}from"./base-lib.js?v=1756369731";import{_ as A}from"./index123.js?v=1756369731";import{_ as O}from"./index104.js?v=1756369731";import{u as B}from"./column.js?v=1756369731";import{restoreBackup as P,downloadBackup as R,deleteBackup as W,getBackupList as z,editBackupConfig as G,getBackupType as K,setBackupStatus as $,getBackupConfig as J}from"./site.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";const L={class:"flex items-center"},Q={class:"flex items-center"},X={class:"p-[20px]"},Y={class:"flex items-center"},Z=p(m({__name:"index",props:{compData:{default:()=>[]}},setup(p,{expose:m}){const Z=p,ee=d(!1),ae=d(!1),te=d(!1),le=d([]),oe=c(Z.compData,"path"),re=d(),ne=h({path:oe.value,time:"30分钟",backupTo:"",type:"day",week:"1",hour:"1",minute:"30",second:"",where1:"1",timeSet:["1"],timeType:"sday"});let se="";const ue=w(()=>ie.value.findIndex(e=>e.type===ne.type)||0);let ie=d([{type:"day",text:"每天",showDay:!1,showHour:!0,showMinute:!0,showSecond:!1},{type:"day-n",text:"N天",showDay:!0,showHour:!0,showMinute:!0,showSecond:!1},{type:"hour",text:"每小时",showDay:!1,showHour:!1,showMinute:!0,showSecond:!1},{type:"hour-n",text:"N小时",showDay:!1,showHour:!0,showMinute:!0,showSecond:!1},{type:"minute-n",text:"N分钟",showDay:!1,showHour:!1,showMinute:!0,showSecond:!1},{type:"week",text:"每周",showDay:!1,showHour:!0,showMinute:!0,showSecond:!1},{type:"month",text:"每月",showDay:!0,showHour:!0,showMinute:!0,showSecond:!1}]);const pe=d([]),me=d(!0),de=h({backupTo:[{required:!0,message:"请选择备份到",trigger:"change"}],where1:[{validator:(e,a,t)=>{"day-n"===ne.type||"month"===ne.type?Number.parseInt(a)>31||Number.parseInt(a)<1||!Number.isInteger(parseFloat(a))?t(new Error("请输入1-31的整数")):""===a?t(new Error("请输入天数")):t():t()},trigger:["blur","change"]}],hour:[{validator:(e,a,t)=>{"minute-n"!==ne.type&&"hour"!==ne.type&&"second-n"!==ne.type||t(),Number.parseInt(a)>23||Number.parseInt(a)<0||!Number.isInteger(parseFloat(a))?t(new Error("请输入0-23的整数")):""===a?t(new Error("请输入小时")):"hour-n"===ne.type&&0===Number.parseInt(a)&&0===Number.parseInt(ne.minute)?t(new Error("小时和分钟不能同时为0")):t()},trigger:["blur","change"]}],minute:[{validator:(e,a,t)=>{Number.parseInt(a)>59||Number.parseInt(a)<0||!Number.isInteger(parseFloat(a))?t(new Error("请输入0-59的整数")):""===a?t(new Error("请输入分钟")):"hour-n"===ne.type&&0===Number.parseInt(a)&&0===Number.parseInt(ne.hour)?t(new Error("小时和分钟不能同时为0")):"minute-n"===ne.type&&(Number.parseInt(a)<1||!/^[1-9]\d*$/.test(a))?t(new Error("请输入1-59的整数")):t()},trigger:["blur","change"]}],second:[{validator:(e,a,t)=>{"second-n"===ne.type?!Number.isInteger(parseFloat(a))||Number.parseInt(a)>59||Number.parseInt(a)<1?t(new Error("请输入1-59的整数")):""===a?t(new Error("请输入秒")):t():t()},trigger:["blur","change"]}],timeSet:[{validator:(e,a,t)=>{"sweek"!==ne.type||a.length?t():t(new Error("请选择时间"))},trigger:"change"}]}),ce=d([{content:"温馨提示：如果文件未发生改变，则不会触发增量备份"},{content:"增量备份第一次备份，会备份一个完整的备份用于恢复，之后的备份则仅备份修改的文件"}]),he=async e=>{await a({width:50,title:"删除备份",content:"删除备份【".concat(e.name,"】后，备份文件将被删除，是否继续操作？"),icon:"warning-filled"});(await t({loading:"正在删除备份，请稍后...",request:W({backup_file:e.name,backup_id:e.id}),message:!0})).status&&await fe()},we=async()=>{try{const{data:{msg:e,status:a}}=await J({src_folder:Z.compData.path});te.value=!(!Array.isArray(e)||!e.length)&&!!e[0].status,Array.isArray(e)&&e.length?(se=e[0].id,Object.keys(ne).forEach(a=>{e[0].hasOwnProperty(a)&&(ne[a]=e[0][a]),e[0].hasOwnProperty("where_".concat(a))&&(ne[a]=e[0]["where_".concat(a)])}),ne.backupTo=e[0].backupTo||"localhost",ne.path=e[0].sName,ye(ne.type)):se=""}catch(e){o(e)}},ye=(e,a=!1)=>{ne.type=e,ne.where1="1","minute-n"===ne.type&&(ne.where1=ne.minute),"hour-n"===ne.type&&(ne.where1=ne.hour),re.value&&re.value.clearValidate()},be=async()=>{await we(),fe()},fe=async()=>{try{me.value=!0;const e=await z({src_folder:Z.compData.path,cron_id:se});e.status?le.value=e.data.msg:l.error(e.msg)}catch(e){}finally{me.value=!1}},ve=async()=>{await re.value.validate();(await t({loading:"正在保存配置，请稍后...",request:G({name:"网站增量备份[ ".concat(Z.compData.name," ]"),...ne,backupTo:ne.backupTo,sName:ne.path,sBody:"",sType:"toShell"}),message:!0})).status&&(ae.value=!1,await we())},ge=async()=>{ne.path=Z.compData.path,await _e(),ae.value=!0},_e=async()=>{var e,a;try{ee.value=!0;const t=await K({type:"sites"});pe.value=(null==(a=null==(e=null==t?void 0:t.data)?void 0:e.orderOpt)?void 0:a.map(e=>({label:e.name,value:e.value})))||[],pe.value.unshift({label:"服务器磁盘",value:"localhost"})}catch(t){o(t)}finally{ee.value=!1}},ke=async e=>{if(e)if(se)await Ve(),await we();else{const e=(()=>{const{week:e,hour:a,minute:t,where1:l,type:o,path:r,backupTo:n}=ne;return{name:"网站增量备份[ ".concat(Z.compData.name," ]"),week:e,hour:a,minute:t,where1:l,type:o,sName:se?r:Z.compData.path,sBody:"",sType:"toShell",backupTo:se?n:"localhost"}})();G(e),ge(),ae.value=!0}else await a({title:"关闭增量文件备份",content:"关闭增量文件备份后，将会删除增量备份配置，是否继续操作？",icon:"warning-filled"}),await Ve(),await we()},Ve=async()=>{await t({request:$({id:se}),message:!0})},xe=j([{prop:"name",label:"备份名称",showOverflowTooltip:!0,minWidth:100,render:e=>g("span",{class:"truncate"},[e.name])},{prop:"backupTo",label:"存储位置"},{prop:"size",label:"备份大小"},{prop:"time",label:"备份时间",width:150},{prop:"type",label:"备份类型",width:80},B([{onClick:async e=>{await a({title:"恢复数据",content:"恢复备份【".concat(e.name,"】到文件后，文件将被覆盖，是否继续操作？"),icon:"warning-filled"}),t({loading:"正在恢复备份，请稍后...",request:P({backup_file:e.name,backup_id:e.id}),message:!0})},width:60,title:"恢复备份"},{onClick:async e=>{const a=await t({request:R({backup_file:e.name,cron_id:se,backup_id:e.id}),data:{path:String,is_local:Boolean}});a.path&&window.open("".concat(a.is_local?"/download?filename="+encodeURIComponent(a.path):a.path),"_blank","noopener,noreferrer")},title:"下载"},{onClick:he,title:"删除"}])]);return y(be),m({init:be}),(a,t)=>{const l=U,o=O,p=H,m=A,d=r,c=n,h=M,w=C,y=q,j=s,B=F,P=u,R=i,W=e,z=b("bt-loading");return f(),v("div",null,[g(W,null,{"header-left":_(()=>[k("div",L,[k("div",Q,[t[11]||(t[11]=k("span",{class:"mr-[4px]"},"启用增量文件备份",-1)),g(l,{modelValue:V(te),"onUpdate:modelValue":t[0]||(t[0]=e=>x(te)?te.value=e:null),onChange:ke},null,8,["modelValue"])]),g(o),g(p,{type:"default",onClick:ge},{default:_(()=>[...t[12]||(t[12]=[N("增量备份配置",-1)])]),_:1})])]),"header-right":_(()=>[g(m,{onRefresh:fe})]),content:_(()=>[I(g(d,{ref:"incrementSiteTable",height:"400",data:V(le),column:V(xe)},null,8,["data","column"]),[[z,V(me)],[z,"正在加载列表，请稍后...","title"]])]),"footer-right":_(()=>[...t[13]||(t[13]=[])]),popup:_(()=>[g(R,{title:"增量文件备份配置",modelValue:V(ae),"onUpdate:modelValue":t[10]||(t[10]=e=>x(ae)?ae.value=e:null),area:60,onConfirm:ve,showFooter:""},{default:_(()=>[k("div",X,[I((f(),D(B,{ref_key:"configFormRef",ref:re,model:V(ne),rules:V(de)},{default:_(()=>[g(h,{label:"备份目录"},{default:_(()=>[g(c,{disabled:"",modelValue:V(ne).path,"onUpdate:modelValue":t[1]||(t[1]=e=>V(ne).path=e),width:"34rem",title:V(ne).path},null,8,["modelValue","title"])]),_:1}),g(h,{label:"执行周期"},{default:_(()=>{var e,a,l,o;return[k("div",Y,[g(y,{class:"!w-[8rem] mr-1rem",modelValue:V(ne).type,"onUpdate:modelValue":t[2]||(t[2]=e=>V(ne).type=e),onChange:t[3]||(t[3]=e=>ye(V(ne).type,!0))},{default:_(()=>[(f(!0),v(T,null,S(V(ie),(e,a)=>(f(),v(T,null,["second-n"!==e.type?(f(),D(w,{key:a,label:e.text,value:e.type},null,8,["label","value"])):E("",!0)],64))),256))]),_:1},8,["modelValue"]),"week"==V(ne).type?(f(),D(h,{key:0,class:"el-form-item-item"},{default:_(()=>[g(y,{modelValue:V(ne).week,"onUpdate:modelValue":t[4]||(t[4]=e=>V(ne).week=e),class:"mr-1rem !w-[8rem]"},{default:_(()=>[g(w,{label:"周一",value:"1"}),g(w,{label:"周二",value:"2"}),g(w,{label:"周三",value:"3"}),g(w,{label:"周四",value:"4"}),g(w,{label:"周五",value:"5"}),g(w,{label:"周六",value:"6"}),g(w,{label:"周日",value:"7"})]),_:1},8,["modelValue"])]),_:1})):E("",!0),(null==(e=V(ie)[V(ue)])?void 0:e.showDay)?(f(),D(h,{key:1,class:"el-form-item-item mr-1rem",prop:"where1"},{default:_(()=>[g(c,{modelValue:V(ne).where1,"onUpdate:modelValue":t[5]||(t[5]=e=>V(ne).where1=e),min:1,width:"10rem",type:"number"},{append:_(()=>[...t[14]||(t[14]=[N("天",-1)])]),_:1},8,["modelValue"])]),_:1})):E("",!0),(null==(a=V(ie)[V(ue)])?void 0:a.showHour)?(f(),D(h,{key:2,class:"el-form-item-item mr-1rem",prop:"hour"},{default:_(()=>[g(c,{modelValue:V(ne).hour,"onUpdate:modelValue":t[6]||(t[6]=e=>V(ne).hour=e),width:"12rem",max:"23",min:"0",type:"number"},{append:_(()=>[...t[15]||(t[15]=[N("小时",-1)])]),_:1},8,["modelValue"])]),_:1})):E("",!0),(null==(l=V(ie)[V(ue)])?void 0:l.showMinute)?(f(),D(h,{key:3,class:"el-form-item-item",prop:"minute"},{default:_(()=>[g(c,{class:"mr-1rem",modelValue:V(ne).minute,"onUpdate:modelValue":t[7]||(t[7]=e=>V(ne).minute=e),width:"12rem",max:"59",min:"0",type:"number"},{append:_(()=>[...t[16]||(t[16]=[N("分钟",-1)])]),_:1},8,["modelValue"])]),_:1})):E("",!0),(null==(o=V(ie)[V(ue)])?void 0:o.showSecond)?(f(),D(h,{key:4,class:"el-form-item-item",prop:"second"},{default:_(()=>[g(c,{modelValue:V(ne).second,"onUpdate:modelValue":t[8]||(t[8]=e=>V(ne).second=e),width:"10rem",max:"59",min:"0",type:"number"},{append:_(()=>[...t[17]||(t[17]=[N("秒",-1)])]),_:1},8,["modelValue"])]),_:1})):E("",!0)])]}),_:1}),g(h,{label:"备份到"},{default:_(()=>[g(j,{modelValue:V(ne).backupTo,"onUpdate:modelValue":t[9]||(t[9]=e=>V(ne).backupTo=e),options:V(pe),class:"!w-24rem"},null,8,["modelValue","options"])]),_:1})]),_:1},8,["model","rules"])),[[z,V(ee)]]),g(P,{options:[V(ce)[0]],class:"mt-[16px] pl-[5rem]"},null,8,["options"])])]),_:1},8,["modelValue"])]),_:1}),g(P,{options:V(ce),class:"mt-[16px] pl-[20px]"},null,8,["options"])])}}}),[["__scopeId","data-v-ca7d228b"]]);export{Z as default};
