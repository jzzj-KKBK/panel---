import{i_ as a,M as s,v as e,i$ as t,W as l,e as n}from"./utils-lib.js?v=1756369731";import{_ as i}from"./index116.js?v=1756369731";import{c as o,r,p as u,a4 as c,q as m,v as p,e as v,A as d,F as _,a_ as f,x,M as g,cc as j,cd as y,y as w,z as h,B as b,C as k,D as z}from"./base-lib.js?v=1756369731";import{a as C}from"./index63.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index103.js?v=1756369731";import"./column.js?v=1756369731";import"./index104.js?v=1756369731";import"./useController6.js?v=1756369731";import"./site.js?v=1756369731";import"./validator.js?v=1756369731";import"./useStore4.js?v=1756369731";const D={class:"p-[2rem] master-step-container"},q={key:0,class:"manual-import-card"},T={class:"file-name"},H={class:"file-size"},I={class:"manual-import-actions"},M=n(o({__name:"index",props:{compData:{default:()=>({slave_ip:""})}},setup(n){const{isRefreshList:o}=C(),M=n,S=r(""),A=r([]),B=r(0);let F=null;const L=r(""),N=r(0),R=r({}),W=r(!0),$={wait:()=>v("span",{class:"svgtofont-el-more-filled text-[#ccc] mr-2px !text-[1.8rem]"},null),done:()=>v("span",{class:"svgtofont-el-circle-check text-[#22c55e] mr-2px !text-[1.8rem]"},null),running:()=>v("span",{class:"svgtofont-el-loading animate-spin text-[#2563eb] mr-2px !text-[1.8rem]"},null)},E={wait:"",done:"完成",running:"进行中"},G=async()=>{if(!W.value)return;const{data:t}=await a({slave_ip:M.compData.slave_ip});t.status||s.error(t.msg);const{data:l}=t,{data:n}=l;S.value=n.logs,A.value=n.steps||[],B.value=A.value.findIndex(a=>"running"===a.status||"wait"===a.status),-1===B.value&&(B.value=A.value.length-1),N.value=n.step,L.value=l.sync_type,"manual"===L.value&&2===N.value&&(W.value=!1,R.value={name:n.master_data_sql,size:e(Number(n.sql_file_size))||"--"});const i=n.step,r=A.value[A.value.length-1];5===i&&r&&"done"===r.status?F&&(clearTimeout(F),F=null,o.value=!0):A.value.some(a=>"done"!==a.status)&&(F=setTimeout(G,2e3))},J=async()=>{const a=s.load("开始同步...");try{const{data:a}=await t({slave_ip:M.compData.slave_ip});a.status?(W.value=!0,o.value=!0,G()):s.error(a.msg||"同步失败")}catch(e){s.error("同步失败")}finally{a.close()}},K=()=>{window.open("/download?filename="+R.value.name)};return u(()=>{W.value=!0,G()}),c(()=>{S.value="",F&&(clearTimeout(F),F=null)}),(a,s)=>{const e=z,t=i,n=l;return m(),p("div",D,[v(x(y),{direction:"vertical",space:"4rem",active:x(B)},{default:d(()=>[(m(!0),p(_,null,f(x(A),(a,s)=>{var e;return m(),g(x(j),{key:s,title:a.msg,icon:$[a.status]?$[a.status]():$.wait(),description:null!=(e=E[a.status])?e:"",status:"done"===a.status?"success":"running"===a.status?"process":"wait"},null,8,["title","icon","description","status"])}),128))]),_:1},8,["active"]),2===x(N)&&"manual"===x(L)?(m(),p("div",q,[w("div",T,"文件名："+h(x(R).name),1),w("div",H,"大小："+h(x(R).size),1),s[2]||(s[2]=w("div",{class:"import-tip"},"提示：请下载上面主库备份文件，在从库数据库页面-选择任意一个需要同步的数据库，进行导入数据",-1)),w("div",I,[v(e,{onClick:K},{default:d(()=>[...s[0]||(s[0]=[b("点击下载",-1)])]),_:1}),v(e,{type:"primary",onClick:J},{default:d(()=>[...s[1]||(s[1]=[b("数据已导入，开始从库配置",-1)])]),_:1})])])):k("",!0),s[3]||(s[3]=w("h3",{class:"text-[1.4rem] mb-[1rem] mt-[1rem] color-[#666]"},"实时日志",-1)),v(t,{content:x(S),isHtml:!0,autoScroll:!0,style:{height:"14rem"}},null,8,["content"]),v(n,{options:[{content:"同步任务为后台进行，此页面可以关闭，在从库列表中可以重新打开"}],class:"mt-[1rem]"})])}}}),[["__scopeId","data-v-3dc48b52"]]);export{M as default};
