var t,a,e,r,s,l,n,o,i;import{K as u,M as p,at as d,o as c,fj as v,G as m,l as y,L as _,a7 as g,r as x,bg as f,j as h}from"./utils-lib.js?v=1756369731";import{j as w,s as j,r as E,k as b,c as P,ay as S,p as k,q as C,v as T,y as V,B as q,e as F,x as L,P as N,A as O,C as I,g as J,al as U,D as A,T as D}from"./base-lib.js?v=1756369731";import{B as M}from"./index418.js?v=1756369731";import{l as R,n as B}from"./form-item.js?v=1756369731";import{n as H}from"./useController6.js?v=1756369731";import{u as X,S as $}from"./useStore4.js?v=1756369731";import{setJavaStaticFile as z,getPythonPortStatus as G,getPortStatus as K,removeServerProxy as Q,bindExtranet as W,unbindExtranet as Y,addServerProxy as Z,modifyServerProxy as tt,addPythonServerProxy as at}from"./site.js?v=1756369731";import{f as et}from"./validator.js?v=1756369731";const rt=w("SITE-EXTERNAL-MAP-STORE",()=>{const{siteInfo:t,siteType:a}=X();return{isRefreshPortList:E(!1),setStaticFileEvent:async a=>{try{const{status:e,index:r,path:s}=a,l=await u({loading:"正在设置静态文件...",request:z({status:e?1:0,index:r,path:s,project_name:t.value.name}),message:!0});return{status:l.status,msg:l.msg}}catch(e){return{status:!1,msg:"设置静态文件失败"}}},getJavaPortData:async()=>{try{const e="python"===a.value?await G({project_name:t.value.name}):await K({project_name:t.value.name});return Array.isArray(e.data.data)?{data:e.data.data,total:e.data.data.length,other:{}}:{data:[],total:0,other:{}}}catch(e){return{data:[],total:0,other:{}}}},deleteProxyEvent:async t=>{try{const a=await u({loading:"正在删除反向代理映射...",request:Q(t),message:!0});return{status:a.status,msg:a.msg}}catch(a){return{status:!1,msg:"删除代理失败"}}},changeStatusEvent:async(t,{status:e})=>{let r=p.load("正在修改状态，请稍后...");try{let r=a.value;const s=e?W:Y,{data:l}=await s(t,r),n=l.msg||l.data||l.error_msg;return{status:l.status,msg:n}}catch(s){return{status:!1,msg:"修改状态失败"}}finally{r.close()}},saveProxyMapEvent:async(t,e)=>{try{let r=()=>{};switch(!0){case"python"===a.value:r=at;break;case e:r=tt;break;case!e:r=Z}const s=await u({loading:"正在操作中，请稍后...",request:r(t)});return{msg:s.msg,status:s.status}}catch(r){d(r)}}}}),{activeType:st,siteInfo:lt,siteType:nt,rowData:ot}=X(),{getFileEvent:it,saveFileEvent:ut,setSiteInfo:pt,getProjectConfig:dt,jumpTabEvent:ct}=$(),{isRefreshPortList:vt}=j(rt()),{setStaticFileEvent:mt,deleteProxyEvent:yt,getJavaPortData:_t,saveProxyMapEvent:gt,changeStatusEvent:xt}=rt(),ft=b({status:null==(e=null==(a=null==(t=lt.value)?void 0:t.project_config)?void 0:a.static_info)?void 0:e.status,index:(null==(l=null==(s=null==(r=lt.value)?void 0:r.project_config)?void 0:s.static_info)?void 0:l.index)||"index.html",path:(null==(i=null==(o=null==(n=lt.value)?void 0:n.project_config)?void 0:o.static_info)?void 0:i.path)||"",popup:!1}),ht=E(!1),wt=E(!1),jt=E(!1),Et=async t=>{const a=await mt(t);return a.status&&(ft.popup=!1,bt()),a.status},bt=async()=>{try{let{project_type:t,name:a}=lt.value,e="python"===t?{name:a}:{project_name:a};const r=await dt(e);if(r.status&&r.data.name){const{project_config:a}=r.data;ht.value=!!a.bind_extranet,wt.value="springboot"!==a.java_type&&"java"===t,a&&pt(r.data)}}catch(t){return{status:!1,msg:"获取域名信息失败"}}},Pt=t=>{let a=t.split("\n").filter(t=>""!==t),e=[];return a.forEach(t=>{let a=t.split("=");e.push({k:a[0],v:a[1]})}),e},St=t=>"".concat(t,"/").replace(/\s+/g,"").replace(/\/\//g,"/"),kt=async t=>{try{const a=nt.value;"java"!==a&&(ht.value=!t,await c({width:40,title:"外网映射",content:"".concat(t?"开启":"关闭","外网映射后，").concat(t?"可以通过绑定域名进行访问":"已绑定域名将取消关联访问","，是否继续操作？"),icon:"warning-filled"}));const{name:e,project_config:r}=lt.value,s={python:{data:JSON.stringify({name:e})},java:{data:JSON.stringify({project_name:e})},default:{data:JSON.stringify({project_name:e,domains:r.domains})}},l=s[a]||s.default,n=await xt(l,{status:t});p.request(n),n.status&&(bt(),vt.value=!0),Ct(n)}catch(a){d(a)}},Ct=t=>{var a,e,r,s,l;const n=nt.value;if("java"===n&&t.msg.includes("域名")){ht.value=!1;const a=()=>{ct("domain")};p.msg({message:"".concat(t.msg,'，<span class="text-primary cursor-pointer go-domains">前往添加域名</span>'),duration:3e3,dangerouslyUseHTMLString:!0,type:"error",onClose:()=>{a&&window.removeEventListener("click",a)}}),a&&window.addEventListener("click",a,{once:!0})}else"java"!==n?t.status||t.data.status?p.success((null==(a=t.data)?void 0:a.msg)||(null==(e=t.data)?void 0:e.data)||t.msg):p.error((null==(r=t.data)?void 0:r.error_msg)||(null==(s=t.data)?void 0:s.msg)||(null==(l=t.data)?void 0:l.data)):p.request(t)},Tt=async(t,a)=>{var e,r;if((null==(r=null==(e=lt.value.project_config)?void 0:e.static_info)?void 0:r.status)&&"/"===t.value.proxy_dir)return p.error("项目已存在根路由【/】配置，无法设置该代理目录"),!1;await a(),t.value.rewrite.src_path=t.value.proxy_dir;try{if(!t.value.status&&t.value.proxy_id)return jt.value=!1,(async t=>{const a={proxy_id:t.proxy_id,site_name:lt.value.name},e=await yt(a);return e.status&&(vt.value=!0),e.status})(t.value);{t.value.rewrite.src_path=St(t.value.rewrite.src_path),t.value.rewrite.target_path=St(t.value.rewrite.target_path);let a=(t=>{let a={python:{site_name:lt.value.name,proxy_port:t.proxy_port,status:t.status?1:0},java:{...t,status:t.status?1:0,site_name:lt.value.name,rewrite:JSON.stringify(t.rewrite),add_headers:JSON.stringify(Pt(t.add_headers))}}[nt.value];return a.isEdit||delete a.proxy_id,delete a.isEdit,a})(t.value);const e=await gt(a,t.value.isEdit);return p.request(e),e.status&&(jt.value=!1,vt.value=!0),e.status}}catch(s){}},Vt={class:"flex flex-col"},qt={class:"flex items-center"},Ft={key:0},Lt={key:0,class:"flex items-center"},Nt={class:"mt-[8px] leading-8 text-[1.2rem] list-disc ml-[20px]"},Ot={key:0,class:"text-danger"},It=P({__name:"index",setup(t,{expose:a}){const{siteType:e,siteInfo:r}=j($()),{isRefreshPortList:s}=j(rt()),{getJavaPortData:l}=rt(),n=S("popupClose"),o=E(!1),{BtTable:i,refresh:u,config:d}=v({request:async()=>await l(),columns:[H(),{label:"防火墙状态",prop:"fire_wall",width:200,render:t=>{var a,e;return F("span",{onClick:()=>{null===t.fire_wall?y({title:"端口规则",area:44,component:()=>_(()=>import("./add-port-rule.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),compData:{...null===t.fire_wall?{port:t.port,isEdit:!1,noNps:!0}:{...t.fire_wall,isEdit:!0,noNps:!0},refreshFn:()=>{bt(),u()}},showFooter:!0}):p.msg({message:F("span",null,[q("请前往系统防火墙模块修改，"),F("span",{class:"text-primary cursor-pointer go-firewall",onClick:b},[q("立即前往")])]),duration:2e3,dangerouslyUseHTMLString:!0,type:"error"})},class:(null===t.fire_wall||"drop"===(null==(a=t.fire_wall)?void 0:a.Strategy)?"text-danger":"text-primary")+" cursor-pointer"},[null===t.fire_wall?"未配置":"accept"===(null==(e=t.fire_wall)?void 0:e.Strategy)?"放行":"禁止"])}},{label:"外网映射",prop:"nginx_proxy",showOverflowTooltip:!1,render:t=>{var a,r,s,l,n;return ht.value?F("div",{class:"flex"},[F("span",{onClick:()=>{let a={isEdit:!1,proxy_dir:"",proxy_id:"",proxy_port:"",site_name:"",rewrite:{status:!1,src_path:"",target_path:""},add_headers:"",status:!0};null!==t.nginx_proxy?(a.isEdit=!0,a.proxy_id=t.nginx_proxy.proxy_id,a.proxy_dir=t.nginx_proxy.proxy_dir,a.proxy_port=t.nginx_proxy.proxy_port,a.site_name=t.nginx_proxy.site_name,a.status=!!t.nginx_proxy.status,"python"!==e.value&&(a.rewrite=t.nginx_proxy.rewrite,a.add_headers=t.nginx_proxy.add_headers.map(t=>"".concat(t.k,"=").concat(t.v)).join("\n"))):(a.isEdit=!1,a.proxy_port=t.port),"python"===e.value&&(a.proxy_dir="/"),z(a)},class:(null===t.nginx_proxy||0===(null==(a=t.nginx_proxy)?void 0:a.status)?"text-danger":"text-primary")+" cursor-pointer max-w-[26rem] truncate",title:null!==t.nginx_proxy&&(null==(r=t.nginx_proxy)?void 0:r.status)?"已开启，代理路由："+(null==(s=t.nginx_proxy)?void 0:s.proxy_dir):""},[null===t.nginx_proxy?"未配置":(null==(l=t.nginx_proxy)?void 0:l.status)?"已开启，代理路由："+(null==(n=t.nginx_proxy)?void 0:n.proxy_dir):"已停止"])," "]):"请先点击上方启用外网映射后再使用"}}],extension:[g(s)]}),w=(t,a)=>({type:"custom",render:a=>(a.value.hasOwnProperty("status")||(a.value.status=!1),F(f,{label:"开启代理"},{default:()=>[F(D,{modelValue:t.value.status,"onUpdate:modelValue":a=>t.value.status=a},null)]}))}),b=()=>{n(),x.push({path:"/firewall/system"})},P=async t=>{var a,e,s,l,n,o;t?X():(await c({title:"确定要关闭静态文件吗？",content:"关闭静态文件后，项目将无法访问静态文件"}),Et({status:!1,index:(null==(s=null==(e=null==(a=r.value)?void 0:a.project_config)?void 0:e.static_info)?void 0:s.index)||"index.html",path:(null==(o=null==(n=null==(l=r.value)?void 0:l.project_config)?void 0:n.static_info)?void 0:o.path)||""}))},X=t=>{var a,e,s,l,n,o;if(!ht.value)return p.error("请先点击上方启用外网映射后再使用");if(d.data.some(t=>{var a;return"/"===(null==(a=t.nginx_proxy)?void 0:a.proxy_dir)}))return r.value.project_config.static_info.status=!1,void p.error("项目已存在根路由【/】配置,无法设置静态文件");const{BtForm:i,submit:u}=m({data:{status:!0,index:(null==(s=null==(e=null==(a=r.value)?void 0:a.project_config)?void 0:e.static_info)?void 0:s.index)||"index.html",path:(null==(o=null==(n=null==(l=r.value)?void 0:l.project_config)?void 0:n.static_info)?void 0:o.path)||""},options:t=>{var a,e;return t.value.status=(null==(e=null==(a=r.value.project_config)?void 0:a.static_info)?void 0:e.status)||!1,J(()=>[{type:"input",label:"默认文档",key:"index",attrs:{placeholder:"请输入内容，用,分割",class:"w-[26rem]"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("默认文档不能为空")):r()}}]},R("文件路径","path",{attrs:{style:"width: 26rem"},rules:[{validator:(a,e,r)=>{t.value.status&&""===e?r(new Error("文件路径不能为空")):r()}}]},()=>{et({type:"dir",path:t.value.path,change:a=>{t.value.path=a}})})])},submit:async(t,a)=>(await a(),Et(t.value))});y({title:"设置静态文件【".concat(r.value.name,"】"),area:65,showFooter:!0,component:()=>F(i,{class:"p-2rem"},null),onConfirm:u,onCancel:()=>{bt()}})},z=t=>{const{BtForm:a,submit:r}=m({data:t,options:t=>J(()=>[w(t),{type:"input",label:"代理路由",key:"proxy_dir",attrs:{width:"26rem",placeholder:"请输入内容，用,分割",disabled:"python"===e.value,onInput:()=>{}},rules:[{required:!0,message:"请输入代理路由",trigger:"blur"}]},{type:"custom",render:a=>F(f,{label:"代理端口",prop:"proxy_port"},{default:()=>[F(M,{modelValue:t.value.proxy_port,"onUpdate:modelValue":a=>t.value.proxy_port=a,"controls-position":"right",class:"!w-[10rem]"},null)]}),rules:{proxy_port:[{required:!0,message:"请输入代理端口",trigger:"blur"},{validator:(t,a,e)=>{/^\d+$/.test(a)?a<0||a>65535?e(new Error("端口号范围为0-65535")):e():e(new Error("端口号必须为数字，范围0-65535"))}}]}},..."python"!==e.value?[B(o),...o.value?[{type:"textarea",label:"自定义头部",key:"add_headers",attrs:{placeholder:"自定义头部，1行1个,例如：\nX-Client-IP=$remote_addr",class:"!w-[26rem]",width:"26rem",rows:4,resize:"none"}},{type:"custom",render:()=>F(f,{label:"路由重写"},{default:()=>[F(D,{modelValue:t.value.rewrite.status,"onUpdate:modelValue":a=>t.value.rewrite.status=a},null)]})},...t.value.rewrite.status?[{type:"custom",render:()=>F(f,{label:"后端路由",prop:"targetPath"},{default:()=>[F(h,{modelValue:t.value.rewrite.target_path,"onUpdate:modelValue":a=>t.value.rewrite.target_path=a,class:"w-[25rem]",placeholder:"后端路由,例如：".concat(t.value.proxy_dir,"/xxx/").replace(/ /g,"").replace(/\/\//g,"/")},null)]})}]:[]]:[]]:[]]),submit:Tt});y({title:"".concat(t.isEdit?"修改反向代理映射":"添加反向代理映射"),area:50,showFooter:!0,component:()=>F(a,{class:"p-2rem"},null),onConfirm:r})};return k(bt),a({init:()=>{bt(),u()}}),(t,a)=>{var s;const l=U,n=A;return C(),T("div",Vt,[V("div",qt,[a[3]||(a[3]=q(" 外网映射 ",-1)),F(l,{modelValue:L(ht),"onUpdate:modelValue":a[0]||(a[0]=t=>N(ht)?ht.value=t:null),class:"ml-[8px]",disabled:L(wt),onChange:L(kt)},null,8,["modelValue","disabled","onChange"])]),"java"===L(e)||"python"===L(e)?(C(),T("div",Ft,[F(L(i),{class:"my-2rem",maxHeight:450}),"springboot"===(null==(s=L(r).project_config)?void 0:s.java_type)?(C(),T("div",Lt,[a[5]||(a[5]=q(" 静态文件： ",-1)),V("span",null,[F(l,{modelValue:L(r).project_config.static_info.status,"onUpdate:modelValue":a[1]||(a[1]=t=>L(r).project_config.static_info.status=t),onChange:P},null,8,["modelValue"])]),F(n,{class:"!ml-[2rem]",type:"default",onClick:a[2]||(a[2]=t=>X())},{default:O(()=>[...a[4]||(a[4]=[q(" 设置静态文件 ",-1)])]),_:1})])):I("",!0)])):I("",!0),V("ul",Nt,[a[6]||(a[6]=V("li",null,"如果您的是HTTP项目，且需要外网通过80/443访问，请开启外网映射",-1)),a[7]||(a[7]=V("li",null,"开启外网映射前，请到【域名管理】中至少添加1个域名",-1)),"java"===L(e)?(C(),T("li",Ot,"外网映射开启后可在配置文件中查看修改服务器（Nginx/Apache）的配置文件")):I("",!0)])])}}});export{It as _};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
