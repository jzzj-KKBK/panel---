import{u as a,R as e,v as l,K as t,M as s,o,gC as n,S as r,k as i,h as u,j as d,e as p}from"./utils-lib.js?v=1756369731";import{_ as m}from"./index103.js?v=1756369731";import{c,U as v,r as g,k as f,aB as h,p as w,G as x,q as b,v as y,e as _,A as k,B as C,x as j,H as V,P as q,y as U,F as A,a_ as S,M as z,Q as B,C as F,D as M,ai as P,aj as R}from"./base-lib.js?v=1756369731";import{_ as D}from"./index112.js?v=1756369731";import{h as H,u as I,a as G}from"./column.js?v=1756369731";import{v as J,g as K}from"./useMethod4.js?v=1756369731";import{getBackupDatabase as L,getMysqlCloudServer as N,getMysqlBackupInfo as O,inputDatabase as Q,getMysqlAllBackup as T,backupDatabase as E}from"./database.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";import"./useStore2.js?v=1756369731";import"./validator.js?v=1756369731";const W={class:"p-20px"},X={class:"p-20px flex flex-col"},Y={key:0},Z={class:"p-16px flex flex-col bg-[#f0f0f0]"},$=p(c({__name:"index",setup(p,{expose:c}){var $;const{panel:aa}=a(),ea=v([]),la=g(null==($=ea.value[0])?void 0:$.id),ta=g(!1),sa=g([]),oa=f({p:1,limit:10,total:0}),na=g({}),ra=g(""),ia=g("detail"),ua=g(!1),da=g([]),pa=g(!1),ma=g(),ca=g(!1),va=g([]),ga=[{label:"数据库名称",prop:"name"},{label:"大小",prop:"size",render:a=>l(a.size)}],fa=(aa.value.backupPath+"/database/mysql/all_backup/").replace(/\/\//g,"/"),ha=async()=>{const a=await t({request:L({sid:la.value}),loading:pa,data:{status:Boolean,msg:String,data:[Array,da]}});a.status||(s.error(a.msg||"获取数据库备份列表失败"),da.value=[])},wa=async()=>{await xa(),await ha(),Ca.value=[G(),{label:"数据库名称",prop:"name",width:200},{label:"表数量",prop:"table_num"},K(ea.value,"mysql"),{label:"大小",prop:"size"}],ua.value=!0},xa=async()=>{var a;await t({loading:"正在获取服务器数据，请稍后...",request:N(),data:[Array,ea]}),la.value=null==(a=ea.value[0])?void 0:a.id},ba=async a=>"detail"===ia.value?a():"我已知晓"!==ra.value?(s.error("输入错误，请重新输入！"),!1):(await t({request:Q({file:na.value.path}),loading:"正在导入数据库，请稍后...",message:!0}),void(ra.value="")),ya=async()=>{await t({request:T({...oa}),loading:ta,data:{data:[Array,sa],page:r(oa)}})},_a=async()=>{const a=ma.value.tableSelectList;if(!a.length)return s.error("请选择需要备份的数据库"),!1;await t({request:E({sid:la.value,db_list:JSON.stringify(a.map(a=>a.name))}),loading:"正在备份中，请稍后...",message:!0}),ua.value=!1,ya()},ka=[{label:"文件名称",prop:"name"},{label:"备份时间",prop:"mtime",width:200,render:a=>{const l=new Date(1e3*a.mtime);return h("span",e(l))}},H({prop:"size",width:100}),I([{onClick:async a=>{await t({request:O({file:a.path}),loading:"正在获取数据库详情，请稍后...",data:{data:[Array,va],msg:String},success:a=>{"ok"!==a.msg?s.error(a.msg):(ia.value="detail",ca.value=!0)}})},title:"详情"},{onClick:async a=>{na.value=a,await t({request:O({file:a.path}),loading:"正在获取数据库详情，请稍后...",data:{data:[Array,va]}}),ca.value=!0,ia.value="restore"},title:"恢复"},{onClick:async a=>{window.open("/download?filename="+encodeURIComponent(a.path),"_blank","noopener,noreferrer")},title:"下载"},{onClick:async a=>{await o({title:"删除文件",content:"删除选中数据库备份文件后，该数据库备份文件将永久消失，是否继续操作？",icon:"warning-filled"}),await t({request:n({path:a.path}),loading:"正在删除文件，请稍后...",message:!0}),ya()},title:"删除"}])],Ca=g();return w(ya),c({init:ya}),(a,e)=>{const l=M,t=i,s=D,o=P,n=R,r=m,p=u,c=d,v=x("bt-loading"),g=x("focus");return b(),y("div",null,[_(r,null,{"header-left":k(()=>[_(l,{onClick:wa,type:"primary"},{default:k(()=>[...e[10]||(e[10]=[C("数据库备份",-1)])]),_:1}),_(l,{onClick:e[0]||(e[0]=a=>j(J)(()=>ya(),j(fa)))},{default:k(()=>[...e[11]||(e[11]=[C("从本地上传",-1)])]),_:1})]),content:k(()=>[V(_(t,{column:ka,data:j(sa)},null,8,["data"]),[[v,j(ta)]])]),"footer-right":k(()=>[_(s,{total:j(oa).total,page:j(oa).p,"onUpdate:page":e[1]||(e[1]=a=>j(oa).p=a),row:j(oa).limit,"onUpdate:row":e[2]||(e[2]=a=>j(oa).limit=a),onChange:e[3]||(e[3]=a=>ya())},null,8,["total","page","row"])]),popup:k(()=>[_(p,{title:"数据库备份",modelValue:j(ua),"onUpdate:modelValue":e[5]||(e[5]=a=>q(ua)?ua.value=a:null),onConfirm:_a,showFooter:"",area:60},{default:k(()=>[U("div",W,[_(r,null,{"header-right":k(()=>[_(n,{class:"!w-[16rem]",modelValue:j(la),"onUpdate:modelValue":e[4]||(e[4]=a=>q(la)?la.value=a:null),onChange:ha},{default:k(()=>[(b(!0),y(A,null,S(j(ea),(a,e)=>(b(),z(o,{key:e,label:a.ps,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),content:k(()=>[V(_(t,{ref_key:"backupTableRef",ref:ma,column:j(Ca),data:j(da),"max-height":"360"},null,8,["column","data"]),[[v,j(pa)],[v,"正在加载列表，请稍后...","title"]])]),_:1})])]),_:1},8,["modelValue"]),_(p,{title:"restore"===j(ia)?"恢复数据库":"数据库详情",modelValue:j(ca),"onUpdate:modelValue":e[8]||(e[8]=a=>q(ca)?ca.value=a:null),showFooter:"",area:60,onConfirm:ba,onCancel:e[9]||(e[9]=a=>ra.value="")},{default:k(()=>[U("div",X,[_(t,{column:ga,data:j(va),"max-height":"360"},null,8,["data"]),"restore"===j(ia)?(b(),y("div",Y,[e[13]||(e[13]=U("div",{class:"flex items-center my-12px text-[1.4rem]"},[U("i",{class:"text-orange svgtofont-el-warning-filled !text-[4rem] mr-8px"}),U("span",null,"恢复后会覆盖当前数据库数据，此操作不可逆，是否继续操作？")],-1)),U("div",Z,[e[12]||(e[12]=U("span",{class:"mb-4px"},[C("请手动输入 "),U("span",{class:"text-danger"},'"我已知晓"'),C(" ，完成验证")],-1)),V(_(c,{modelValue:j(ra),"onUpdate:modelValue":e[6]||(e[6]=a=>q(ra)?ra.value=a:null),width:"52rem",onPasteCapture:e[7]||(e[7]=B(()=>{},["prevent"]))},null,8,["modelValue"]),[[g]])])])):F("",!0)])]),_:1},8,["title","modelValue"])]),_:1}),e[14]||(e[14]=U("ul",{class:"mt-16px leading-8 text-[1.2rem] list-disc ml-20px"},[U("li",null,"恢复仅限于在本页面进行的备份进行恢复，非本页面的备份数据可能无法正确恢复，请注意。")],-1))])}}}),[["__scopeId","data-v-e649dda0"]]);export{$ as default};
