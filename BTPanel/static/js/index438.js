import{u as e,K as a,at as t,aq as l,$ as s,J as n,k as o,j as i,h as r,b as c,R as u,o as d,l as m,L as p,a0 as v,a2 as y,W as f,e as b}from"./utils-lib.js?v=1756369731";import{c as _,r as g,U as h,k as w,p as x,G as A,q as V,v as k,x as j,e as C,A as q,y as U,B as I,P as T,H as R,M as S,D as z,al as B,a9 as D,a7 as E,aB as F,C as H,z as P}from"./base-lib.js?v=1756369731";import{_ as L}from"./index117.js?v=1756369731";import{_ as N}from"./index103.js?v=1756369731";import{getUserCert as M,getSslConfig as O,setSslConfig as G,getSslList as J,setSslVerify as K,getSslSiteList as W,downClientPfx as $,revokeClientCert as Q,deleteDirAuth as X,delFileDeny as Y,deleteDirAuthMultiple as Z,getFileDeny as ee,getDirAuth as ae}from"./site.js?v=1756369731";import{u as te}from"./useStore4.js?v=1756369731";import{_ as le}from"./index130.js?v=1756369731";import{a as se,u as ne}from"./column.js?v=1756369731";import{o as oe}from"./useController6.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./validator.js?v=1756369731";import"./index104.js?v=1756369731";import"./index.vue_vue_type_style_index_0_scoped_b3c4124c_lang.js?v=1756369731";const ie={class:"h-full overflow-auto"},re={key:0},ce={class:"flex items-center"},ue={class:"ml-[20px]"},de={class:"flex items-center"},me={class:"p-[20px]"},pe={class:"p-[20px]"},ve=_({__name:"index",setup(m){const p=c(),{payment:v}=e(),{siteInfo:y}=te(),{authType:f}=v.value,b=g(null),_=g({status:!0}),H=g({title:"限制访问型证书-功能介绍",ps:"提供双向认证证书，可用于限制指定人员访问",source:61,isInstall:!1,desc:["限制指定人员访问","双向认证","内网自签SSL"],height:36,tabImgs:["https://www.bt.cn/Public/new/plugin/introduce/site/ssl_verify_preview.png"]}),P=[{label:"全部",value:0},{label:"正常",value:1},{label:"已撤销",value:-1}],X=h([{label:"使用者",prop:"client"},{label:"公司名称",prop:"company"},{label:"到期时间",width:220,render:e=>{if(e.day){let a=e.addtime+24*e.day*60*60;return C("span",null,[u(a,"yyyy-mm-dd"),I("（剩余"),e.day,I("天）")])}return"--"}},{label:"状态",render:e=>C("span",null,[1===e.status?"正常":0===e.status?"未知":"已撤销"])},{label:"操作",align:"right",render:e=>1!==e.status?F("span",{},"--"):F("div",[F("span",{class:{hidden:1!==e.status||e.day>30,"mr-[8px]":!0,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{try{const a=await M({client:e.client});p.request(a),Ae()}catch(a){}}},"续签"),F("span",{class:{"mr-[8px]":!0,hidden:1!==e.status,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{let a=p.load("正在请求下载，请稍后...");try{const t=await $({id:e.id});t.status?(window.open("/download?filename="+t.msg,"_blank","noopener,noreferrer"),a.close()):p.error(t.msg)}catch(t){}finally{a.close()}}},"下载"),F("span",{class:{hidden:1!==e.status,"bt-link":!0,"cursor-pointer":!0},onClick:async()=>{be(e)}},"撤销")])}]),Y=g([]),Z=g(!1),ee=g(0),ae=g(""),le=g(!1),se=g(!1),ne=g(!1),oe=w({company:"",domain:""}),ve=w({client:""}),ye=w({company:[{required:!0,message:"请输入公司名称",trigger:"blur"}],domain:[{required:!0,message:"请输入域名列表",trigger:"blur"}]}),fe=async()=>{(await a({loading:"正在生成，请稍后...",request:M({client:ve.client}),message:!0})).status&&_e()},be=async e=>{await d({title:"撤销证书【".concat(e.client,"】的访问证书"),content:"撤销颁发的访问证书后，证书将不在可用，是否继续操作？",icon:"warning-filled"});(await a({loading:"正在撤销，请稍后...",request:Q({id:e.id}),message:!0})).status&&Ae()},_e=()=>{le.value=!1,ve.client=""},ge=()=>{var e;se.value=!1,null==(e=b.value)||e.clearValidate()},he=async()=>{await we(),se.value=!0},we=async()=>{try{if(H.value.isInstall||"ltd"!==f)return;const e=await O();e.data.length||se.value||(p.error("请先完善证书配置"),se.value=!0),oe.company=e.data[0].company,oe.domain=e.data[0].domain,ge()}catch(e){t(e)}},xe=async()=>{await b.value.validate();(await a({loading:"正在设置，请稍后...",request:G(oe),message:!0})).status&&ge()},Ae=async()=>{var e,a,s;try{Z.value=!0;const{data:t}=await J({status:ee.value,search:ae.value});if((null==(e=t.msg)?void 0:e.includes("插件不存在"))||(null==(a=t.msg)?void 0:a.includes("未购买"))||(null==(s=t.msg)?void 0:s.includes("已到期"))){try{const{data:e}=await l({sName:"ssl_verify"});_.value.status=e.endtime>-1&&e.setup,H.value.isInstall="ltd"===f?!e.setup||"":!e.setup&&e.endtime>-1||"",H.value.pluginInfo=e}catch(n){}return}_.value.status=!0,Y.value=t}catch(n){t(n)}finally{Z.value=!1}},Ve=async e=>{const t=await a({loading:"正在设置，请稍后...",request:K({siteName:y.value.name,status:e?1:0}),message:!0});ne.value=t.status?e:!e,t.status&&(ne.value=e,ke(),Ae())},ke=async()=>{let e=p.load("正在获取状态，请稍后...");try{(await W()).data.forEach(e=>{e.name===y.value.name&&(ne.value=e.ssl_verify)})}catch(a){t(a)}finally{e.close()}};return x(async()=>{await Ae(),await we(),_.value.status&&await ke()}),(e,a)=>{var t;const l=z,c=B,u=s,d=n,m=o,p=i,v=D,y=E,f=r,g=N,h=L,w=A("bt-loading");return V(),k("div",ie,[(null==(t=j(_))?void 0:t.status)?(V(),k("div",re,[C(g,null,{"header-left":q(()=>[U("div",ce,[C(l,{onClick:a[0]||(a[0]=e=>le.value=!0),type:"primary"},{default:q(()=>[...a[9]||(a[9]=[I("生成证书",-1)])]),_:1}),U("div",ue,[a[10]||(a[10]=I(" 双向认证开关 ",-1)),C(c,{modelValue:j(ne),"onUpdate:modelValue":a[1]||(a[1]=e=>T(ne)?ne.value=e:null),onChange:Ve},null,8,["modelValue"])])])]),"header-right":q(()=>[U("div",de,[C(u,{type:"button",modelValue:j(ee),"onUpdate:modelValue":a[2]||(a[2]=e=>T(ee)?ee.value=e:null),options:P,onChange:Ae,class:"mr-[1rem] !flex-nowrap"},null,8,["modelValue"]),C(d,{class:"ml-[12px] w-[16rem]",modelValue:j(ae),"onUpdate:modelValue":a[3]||(a[3]=e=>T(ae)?ae.value=e:null),onSearch:Ae,placeholder:"请输入使用者"},null,8,["modelValue"])])]),content:q(()=>[R(C(m,{column:j(X),data:j(Y)},null,8,["column","data"]),[[w,j(Z)]])]),"footer-left":q(()=>[C(l,{type:"default",onClick:he},{default:q(()=>[...a[11]||(a[11]=[I("证书配置",-1)])]),_:1})]),"footer-right":q(()=>[...a[12]||(a[12]=[])]),popup:q(()=>[C(f,{title:"生成证书",modelValue:j(le),"onUpdate:modelValue":a[5]||(a[5]=e=>T(le)?le.value=e:null),area:42,showFooter:"",onCancel:_e,onConfirm:fe},{default:q(()=>[U("div",me,[C(y,{model:j(ve),ref:"generateFormRef"},{default:q(()=>[C(v,{label:"使用者"},{default:q(()=>[C(p,{modelValue:j(ve).client,"onUpdate:modelValue":a[4]||(a[4]=e=>j(ve).client=e),placeholder:"请输入使用者（如“研发部-张三”）",width:"24rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])])]),_:1},8,["modelValue"]),C(f,{title:"证书配置",modelValue:j(se),"onUpdate:modelValue":a[8]||(a[8]=e=>T(se)?se.value=e:null),area:42,showFooter:"",onConfirm:xe},{default:q(()=>[U("div",pe,[C(y,{model:j(oe),ref_key:"certFormRef",ref:b,rules:j(ye)},{default:q(()=>[C(v,{label:"公司名称",prop:"company"},{default:q(()=>[C(p,{modelValue:j(oe).company,"onUpdate:modelValue":a[6]||(a[6]=e=>j(oe).company=e),placeholder:"请输入公司名称",width:"24rem"},null,8,["modelValue"])]),_:1}),C(v,{label:"使用者",prop:"domain"},{default:q(()=>[C(p,{type:"textarea",resize:"none",rows:6,modelValue:j(oe).domain,"onUpdate:modelValue":a[7]||(a[7]=e=>j(oe).domain=e),placeholder:"请输入域名列表，多个域名可以用英文状态下的逗号隔开",width:"24rem"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])]),_:1},8,["modelValue"])]),_:1}),a[13]||(a[13]=U("ul",{class:"list-disc mt-[20px] pl-[28px]"},[U("li",null,"双向认证仅支持【HTTPS访问】，如需全站设置，还需通过网站设置开启【强制HTTPS】."),U("li",null,"给网站开启【双向认证】，开启后用户需要将【证书】导入到浏览器后才能访问该网站（目前支持Nginx/Apache）")],-1))])):(V(),S(h,{key:1,data:j(H),class:"!px-[20px] !pt-[8px]"},null,8,["data"]))])}}}),ye={class:"relative"},fe=_({__name:"index",props:{tabActive:{default:"encryptedAccess"},compData:{default:()=>({})}},setup(l){const s=l,{plugin:n}=e(),{siteInfo:i}=te(),r=c(),u=g(),y=g(!1),f=g([]),b=g(!1),_=async e=>{let t="encryptedAccess"===s.tabActive;await d({title:"删除".concat(t?"加密":"禁止","访问规则【").concat(e.name,"】"),content:"删除选中的规则后，".concat(t?"访问".concat(e.site_dir,"将不再需要安全验证，"):"该保护目录将失去防护，","是否继续操作？"),icon:"warning-filled",type:"calc"});(await a({loading:"正在删除，请稍后...",request:t?X({id:i.value.id,name:e.name}):Y({website:i.value.name,deny_name:e.name}),message:!0})).status&&T()},w=e=>{const a="encryptedAccess"===s.tabActive;m({isAsync:!0,title:"".concat(e?"编辑":"添加").concat(a?"加密访问":"禁止访问"),area:a&&e?58:46,showFooter:!a||!e,compData:{...e,id:i.value.id,website:i.value.name,refresh:T},component:()=>p(a?e?()=>import("./edit-pass-limit.js?v=1756369731"):()=>import("./add-pass-limit.js?v=1756369731"):()=>import("./add-forbid-limit.js?v=1756369731"),__vite__mapDeps([]),import.meta.url)})},T=()=>{"encryptedAccess"===s.tabActive?(async()=>{try{y.value=!0;const e=await ae({id:i.value.id});f.value=e.data[i.value.name]}catch(e){t(e)}finally{y.value=!1}})():"forbidAccess"===s.tabActive&&(async()=>{a({loading:y,request:ee({website:i.value.name}),data:[Array,f]})})()},B="encryptedAccess"===s.tabActive?h([se(),{label:"加密访问",prop:"site_dir"},{label:"名称",prop:"name"},{label:"用户",prop:"user_list",render:e=>e.user_list.join(",")},ne([{onClick:w,title:"编辑"},{onClick:_,title:"删除"}])]):h([{label:"名称",prop:"name"},{label:"保护的目录",prop:"dir"},{label:"规则",prop:"suffix"},ne([{onClick:w,title:"编辑"},{onClick:_,title:"删除"}])]),D=[{label:"删除加密访问",value:"delete",event:async(e,a,l,s,n)=>{var o;await d({title:"批量删除加密访问规则",content:"批量删除选中的加密访问规则，该操作可能会存在风险，是否继续？"});let c=r.load("正在删除,请稍后...");try{const e=await Z({site_id:i.value.id,names:l.value.map(e=>e.name)});let a=null==(o=e.data.success)?void 0:o.map(e=>({name:e,status:!0}));Object.keys(e.data.error).forEach(t=>{a.push({name:t,status:!1,msg:e.data.error[t]})}),oe({resultData:a,resultTitle:"删除加密访问规则"}),T(),n()}catch(u){t(u)}finally{c.close()}}}];return x(()=>{"nginx"!=n.value.webserver?(r.error("不支持nginx之外的服务器!"),b.value=!0):(b.value=!1,T())}),(e,a)=>{const t=le,l=z,n=o,i=v,r=N,c=A("bt-loading");return V(),k("div",ye,[j(b)?(V(),S(t,{key:0},{content:q(()=>[...a[1]||(a[1]=[U("div",{class:"content-mask"},[U("i",{class:"svgtofont-el-warning text-warning !text-[2.2rem] mr-4px"}),I(" 不支持nginx之外的服务器 ")],-1)])]),_:1})):H("",!0),C(r,null,{"header-left":q(()=>[C(l,{type:"primary",onClick:a[0]||(a[0]=e=>w())},{default:q(()=>[I("添加"+P("encryptedAccess"===s.tabActive?"加密":"禁止")+"访问",1)]),_:1})]),"header-right":q(()=>[...a[2]||(a[2]=[])]),content:q(()=>[R(C(n,{column:j(B),ref_key:"encryptedAccessRef",ref:u,data:j(f)},null,8,["column","data"]),[[c,j(y)]])]),"footer-left":q(()=>["encryptedAccess"===s.tabActive?(V(),S(i,{key:0,"table-ref":j(u),options:j(D)},null,8,["table-ref","options"])):H("",!0)]),_:1})])}}}),be=b(_({__name:"index",setup(a){const{enterpriseRec:t}=e(),l=g("encryptedAccess"),{BtTabs:s}=y({type:"card",value:l,options:[{label:"加密访问",lazy:!0,name:"encryptedAccess",render:C(fe,{tabActive:"encryptedAccess"},null)},{label:"禁止访问",lazy:!0,name:"forbidAccess",render:C(fe,{tabActive:"forbidAccess"},null)},...t.value?[{label:()=>C("span",{innerHTML:'<span class="inline-flex items-center">\n\t\t\t\t\t\t\t\t<i\n\t\t\t\t\t\t\t\t\tclass="svgtofont-icon-ltd text-[1.6rem] text-[#9B7E48] mr-[4px] inline-flex"></i>\n\t\t\t\t\t\t\t\t双向认证 <span class="text-orange">【推荐】</span></span\n\t\t\t\t\t\t\t>'},null),lazy:!0,name:"addBatch",render:C(ve,null,null)}]:[]]}),n=g([{content:"目录设置加密访问后，访问时需要输入账号密码才能访问"},{content:"例如我设置了加密访问 /test/ ,那我访问 http://aaa.com/test/ 时就要输入账号密码才能访问"}]),o=g([{content:"后缀：禁止访问的文件后缀"},{content:"目录：规则会在这个目录内生效"}]);return(e,a)=>{const t=f;return V(),k("div",null,[C(j(s),{type:"card",modelValue:j(l),"onUpdate:modelValue":a[0]||(a[0]=e=>T(l)?l.value=e:null)},null,8,["modelValue"]),["encryptedAccess","forbidAccess"].includes(j(l))?(V(),S(t,{key:0,options:"encryptedAccess"===j(l)?j(n):j(o),class:"ml-[20px] mt-[20px]"},null,8,["options"])):H("",!0)])}}}),[["__scopeId","data-v-ad816e30"]]);export{be as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
