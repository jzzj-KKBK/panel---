import{u as e,A as a,K as t,ai as l,ag as s,J as o,W as r,k as n,h as u,b as i}from"./utils-lib.js?v=1756369731";import{c,s as m,k as d,r as p,e as f,w as v,p as h,G as y,q as _,v as g,A as x,x as w,B as k,F as b,y as C,C as S,M as j,a_ as L,z as N,J as V,P as D,H as T,ax as A,ag as I,af as O,a9 as P,T as H,ai as J,aj as M,au as U,D as W,aw as q,a7 as B,n as z}from"./base-lib.js?v=1756369731";import{_ as R}from"./index103.js?v=1756369731";import{validateDomain as X,authDomainApi as E,setCertToSite as F}from"./site.js?v=1756369731";import{A as G,z as K,B as Q,C as Y}from"./ssl.js?v=1756369731";import{u as Z}from"./useStore4.js?v=1756369731";import{u as $}from"./useStore12.js?v=1756369731";import{g as ee}from"./useStore10.js?v=1756369731";import{d as ae,r as te}from"./useMethod10.js?v=1756369731";import{l as le,c as se,u as oe}from"./useController13.js?v=1756369731";import{u as re}from"./useStore11.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";import"./column.js?v=1756369731";import"./useController6.js?v=1756369731";import"./validator.js?v=1756369731";import"./useController5.js?v=1756369731";import"./useMethod5.js?v=1756369731";import"./useController4.js?v=1756369731";const ne={class:"py-[1.6rem] relative w-[90%] mx-[auto]"},ue={key:0},ie={class:"!max-h-[20rem] overflow-auto"},ce=["title"],me={key:1},de={class:"!max-h-[20rem] overflow-auto"},pe=["title"],fe={class:"p-[1.5rem]"},ve={class:"ml-[.4rem] text-danger"},he={class:"max-h-[38rem] overflow-auto"},ye={key:0,class:"flex justify-end"},_e=c({__name:"apply-lest-ssl",emits:["close"],setup(c,{emit:_e}){const{encryptIsRefresh:ge}=m(re()),{mainHeight:xe}=e(),we=i(),ke=_e,{siteInfo:be}=Z(),{setApplyInfo:Ce,letApplyInfo:Se}=$(),{refs:{isRefreshDomainConfigList:je}}=ee(),Le=d({resource:"0",autoWildcard:!1,auth_to:!1,checkAll:!1,domain:[],checkList:[]}),Ne=p(!1);p([]);const Ve=p([]),De=d({}),Te=p(!1),Ae=[{content:"注意：请勿将SSL证书用于非法网站",class:"text-danger"},{content:"如开启后无法使用HTTPS访问，请检查安全组是否正确放行443端口"},{content:"在DNS验证中，我们提供了多种自动化DNS-API，并提供了手动模式"},{content:"使用DNS接口申请证书可自动续期，手动模式下证书到期后需重新申请"}],Ie=p([{label:"解析域名",prop:"domain"},{label:"记录值",prop:"auth_value",render(e,t){const l="dns"===De.auth_type?e.auth_value:e.file_path;return f("div",{class:"flex items-center"},[f("div",{class:"truncate w-[15rem]"},[l]),f("span",{class:"svgtofont-icon-copy ml-[4px] text-[#666] text-[1.6rem] w-[1.6rem] cursor-pointer",onClick:()=>a({value:l})},null)])}},{label:"类型",prop:"type",render:(e,t)=>"dns"===De.auth_type?f("span",null,[e.type]):f("div",{class:"flex items-center"},[f("div",{class:"truncate w-[15rem]"},[e.content]),f("span",{class:"svgtofont-icon-copy ml-[4px] text-[#666] text-[1.6rem] w-[1.6rem] cursor-pointer",onClick:()=>a({value:e.content})},null)])},{label:"必需",prop:"must",width:100}]),Oe=p([]),Pe=p(!1),He=p(""),Je=p([{text:"解析域名需要一定时间来生效,完成所以上所有解析操作后,请等待1分钟后再点击验证按钮"},{text:""},{text:"若您使用的是宝塔云解析插件,阿里云DNS,DnsPod作为DNS,可使用DNS接口自动解析"}]),Me=async()=>{const e=await le(),a=await t({request:X({index:De.index}),message:!1});e._props.onCancel(),!0===a.status?(Te.value=!1,Ue(a,!0)):se(a,Ve.value,De)},Ue=async({index:e},a=!1,l=be.value.name)=>{const s=await t({loading:"正在部署证书，请稍候...",request:F({index:e,siteName:l}),message:!1,data:{status:Boolean,msg:String}});oe(s,a)},We=p([]),qe=p(""),Be=p([]),ze=p(null),Re=p([]),Xe=p(!0),Ee=p(""),Fe=p(!1),Ge=async(e=!1)=>{let a;try{let e={site_id:"1"===Le.resource?We.value.join(","):qe.value};Ne.value=!0,a=we.load("正在获取域名列表，请稍后...");const{data:t}=await Y(e);if(Le.domain=t.map(e=>e.name),Be.value=t,"1"===Le.resource){const e=Le.checkList.filter(e=>We.value.includes(e.site_id));await z(),e.forEach(e=>{const a=Be.value.find(a=>a.name===e.name);a&&ze.value.toggleRowSelection(a,!0)})}}catch(t){}finally{a&&a.close(),Ne.value=!1}},Ke=({row:e})=>{if(!e.name.includes(Ee.value)&&Fe.value)return"!hidden"},Qe=e=>{Le.checkList=e},Ye=e=>{Le.checkList=e},Ze=async()=>{await Ge()},$e=async e=>{"1"===Le.resource?We.value=e:qe.value=e,await Ge()},ea=e=>{Fe.value=!0,Ee.value=e},aa=()=>{Fe.value=!0},ta=()=>{Ee.value="",Fe.value=!1},la=e=>e.map(e=>e.name),sa=async()=>{if(0===Le.checkList.length)return void we.error("请选择一个域名");if("1"===Le.resource&&Le.checkList.some(e=>0===e.status)&&!Le.auth_to)return void we.error("选中的域名存在未设置DNS接口配置");if("1"===Le.resource&&Le.autoWildcard&&Le.checkList.some(e=>-1!==e.name.indexOf("*")))return void we.error("开启自动组合泛域名时不能选择泛域名");let e={domains:JSON.stringify(la(Le.checkList)),auth_type:"1"==Le.resource?"dns":"http",auth_to:JSON.stringify(la(Le.checkList)),auto_wildcard:Le.autoWildcard?"1":"0"};"1"==Le.resource&&(e.auth_to=Le.auth_to?"dns":JSON.stringify(la(Le.checkList)));try{const a=await le(),t=await K(e);a._props.onCancel(),t.status&&(ke("close"),ge.value=!0),oa(t.data,e),Je.value[1].text="可通过CMD命令来手动验证域名解析是否生效: nslookup -q=txt _acme-challenge.".concat(la(Le.checkList)[0].replace("*.",""))}catch(a){}},oa=(e,a)=>{if(!1===e.status&&e.hasOwnProperty("msg")&&l(e.msg))we.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:e.msg,type:"error",showClose:!0,duration:0});else if(!0!==e.status&&"pending"!==e.status&&void 0===(null==e?void 0:e.save_path))se(e,Se.value.dnsTable,Se.value.info);else{if("pending"===e.status&&"dns"===a.auth_type){Oe.value=[];for(let a=0;a<e.auths.length;a++){let t=[];const l=e.auths[a].domain.replace("*.","");t.push({domain:"_acme-challenge.".concat(l),type:"TXT",auth_value:e.auths[a].auth_value,must:"是",force:"是"}),t.push({domain:l,type:"CAA",auth_value:'0 issue "letsencrypt.org"',must:"否",force:"否"}),Oe.value.push({domain:e.auths[a].domain,data:t})}return e.hasOwnProperty("error")?Pe.value=e.error:Pe.value=!1,Ce(e,a),void(Te.value=!0)}ra(e)}},ra=async e=>{let a;try{a=we.load("正在部署证书，请稍后...");let l=[];l="1"===Le.resource?We.value.map(e=>Re.value.find(a=>a.id===e)).filter(e=>e).map(e=>({siteName:e.name})):[{siteName:Re.value.find(e=>e.id===qe.value).name}];const s=await t({request:Q({BatchInfo:JSON.stringify(l),privkey:e.private_key,fullchain:e.cert+e.root})});let o={resultData:[...s.data.faildList,...s.data.successList],resultTitle:"部署结果",resultColumn:[{label:"站点名称",prop:"siteName"},{label:"操作结果",render:e=>f("div",{class:e.status?"text-primary":"text-danger"},[e.status?"操作成功":f("span",{class:"flex items-center"},[k("操作失败，"),f(A,{popperClass:"el-popover-shadow el-light-popover",trigger:"hover",placement:"top-start",enterable:!1,"open-delay":400,"close-delay":0},{default:()=>[f("span",{class:"inline-block",innerHTML:e.error_msg||"暂无详情"},null)],reference:()=>f("span",{class:"text-primary cursor-pointer"},[k("详情")])})])])}]};await te(o)}catch(l){}finally{a&&a.close()}};return v(je,e=>{e&&((async()=>{let e;try{e=we.load("正在获取站点列表，请稍后...");const{data:a}=await G();a.length&&(Re.value=a,Xe.value&&(We.value[0]=a[0].id,qe.value=a[0].id,Xe.value=!1),await Ge())}catch(a){}finally{e&&e.close()}})(),je.value=!1)},{immediate:!0}),h(()=>{je.value=!0}),(e,a)=>{const t=I,l=O,i=P,c=H,m=J,d=s,p=M,v=o,h=U,z=W,X=q,F=R,G=B,K=r,Q=n,Y=u,Z=y("bt-loading");return _(),g("div",ne,[f(G,{class:"mb-[2rem]"},{default:x(()=>[f(i,{label:"验证方法"},{default:x(()=>[f(l,{modelValue:w(Le).resource,"onUpdate:modelValue":a[0]||(a[0]=e=>w(Le).resource=e),onChange:Ze},{default:x(()=>[f(t,{label:"0",value:"0"},{default:x(()=>[...a[5]||(a[5]=[k("文件验证",-1)])]),_:1}),f(t,{label:"1",value:"1"},{default:x(()=>[...a[6]||(a[6]=[k("DNS验证(支持通配符)",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),"1"==w(Le).resource?(_(),g(b,{key:0},[f(i,{label:" ",class:"!mt-[-.3rem]"},{default:x(()=>[f(c,{modelValue:w(Le).auth_to,"onUpdate:modelValue":a[1]||(a[1]=e=>w(Le).auth_to=e)},{default:x(()=>[...a[7]||(a[7]=[k(" 手动解析",-1)])]),_:1},8,["modelValue"])]),_:1}),f(i,{label:" ",class:"!mt-[-.3rem] !mb-[2rem]"},{default:x(()=>[f(c,{modelValue:w(Le).autoWildcard,"onUpdate:modelValue":a[2]||(a[2]=e=>w(Le).autoWildcard=e)},{default:x(()=>[...a[8]||(a[8]=[k(" 自动组合泛域名",-1)])]),_:1},8,["modelValue"]),a[9]||(a[9]=C("div",{class:"text-[1.2rem]"},"* 如需申请通配符域名请勾选此项，且不要在下方域名列表中选中泛域名",-1))]),_:1})],64)):S("",!0),f(i,{label:"网站"},{default:x(()=>[C("div",null,["1"==w(Le).resource?(_(),g("div",ue,[(_(),j(d,{multiple:!0,filterable:"","model-value":w(We),class:"mr-[.8rem] !w-[22rem] max-h-[100px] overflow-auto",key:w(Le).resource,onChange:$e},{default:x(()=>[C("div",ie,[(_(!0),g(b,null,L(w(Re),(e,a)=>(_(),j(m,{key:a,label:e.name,value:e.id},{default:x(()=>[C("span",{class:"!w-[22rem] truncate",title:e.name,style:{float:"left"}},N(e.name),9,ce)]),_:2},1032,["label","value"]))),128))])]),_:1},8,["model-value"]))])):(_(),g("div",me,[(_(),j(p,{filterable:"","model-value":w(qe),class:"mr-[.8rem] !w-[22rem]",key:w(Le).resource,onChange:$e},{default:x(()=>[C("div",de,[(_(!0),g(b,null,L(w(Re),(e,a)=>(_(),j(m,{key:a,label:e.name,value:e.id},{default:x(()=>[C("span",{class:"!w-[22rem] truncate",title:e.name,style:{float:"left"}},N(e.name),9,pe)]),_:2},1032,["label","value"]))),128))])]),_:1},8,["model-value"]))])),a[10]||(a[10]=C("div",{class:"text-[1.2rem] mt-[.5rem]"},"* 根据网站筛选下方域名",-1))])]),_:1}),f(i,{label:"域名"},{default:x(()=>[C("div",{class:V(["w-[60rem] !relative border-[1px] border-[#ececec]",w(xe)>1e3?"h-[52rem]":"h-[31rem]"])},[f(v,{class:"!absolute right-[1rem] top-[.7rem] z-99 !w-[200px]",modelValue:w(Ee),"onUpdate:modelValue":a[3]||(a[3]=e=>D(Ee)?Ee.value=e:null),onSearch:ea,onClear:ta,onBlur:aa,placeholder:"搜索域名"},null,8,["modelValue"]),f(F,null,{content:x(()=>[T((_(),j(X,{ref_key:"domainTable",ref:ze,class:"!mb-[1rem] mt-[-1.2rem]","row-class-name":Ke,onSelectionChange:Qe,onSelectAll:Ye,data:w(Be),"max-height":w(xe)<1e3?290:500,description:"列表为空"},{default:x(()=>[f(h,{type:"selection",width:"35"}),f(h,{prop:"name",label:"域名"},{default:x(e=>[e.row.apply_ssl?(_(),j(w(A),{key:0,placement:"top-start",trigger:"hover",offset:-100},{reference:x(()=>[C("span",null,N(e.row.name),1)]),default:x(()=>[a[11]||(a[11]=C("div",{class:"flex flex-col"},[C("span",null,"Let's Encrypt证书不支持申请IP证书"),C("span",null,"请选择【商用证书】的多域名SSL证书申请")],-1))]),_:2},1024)):S("",!0)]),_:1}),f(h,{align:"right"},{default:x(e=>["1"!==w(Le).resource||0!==e.row.status||w(Le).auth_to?S("",!0):(_(),j(z,{key:0,size:"small",type:"primary",class:"ml-auto",onClick:a=>w(ae)(e.row)},{default:x(()=>[...a[12]||(a[12]=[k("配置DNS",-1)])]),_:2},1032,["onClick"]))]),_:1})]),_:1},8,["data","max-height"])),[[Z,w(Ne)],[Z,"正在加载域名列表，请稍后...","title"]])]),_:1})],2)]),_:1}),f(i,{label:" "},{default:x(()=>[f(z,{type:"primary",onClick:sa},{default:x(()=>[...a[13]||(a[13]=[k("申请证书",-1)])]),_:1})]),_:1})]),_:1}),f(K,{options:Ae,class:"pl-2rem"}),f(Y,{modelValue:w(Te),"onUpdate:modelValue":a[4]||(a[4]=e=>D(Te)?Te.value=e:null),area:70,title:"手动".concat("dns"===w(De).auth_type?"解析TXT记录":"创建验证文件")},{default:x(()=>[C("div",fe,[a[16]||(a[16]=k(" 请按以下列表做TXT解析: ",-1)),C("span",ve,N(w(He)),1),f(F,null,{content:x(()=>[C("div",he,[(_(!0),g(b,null,L(w(Oe),(e,t)=>(_(),g(b,null,[e.data.length?(_(),g("div",{key:t},[C("span",null,"验证域名："+N(e.domain),1),f(Q,{class:"my-[1rem]",column:w(Ie),data:e.data},null,8,["column","data"]),w(Pe)?(_(),g("div",ye,[f(z,{type:"default",onClick:a=>(async e=>{const a=await le(),{data:t}=await E({index:De.index,domain:e.domain});a._props.onCancel(),"valid"===t.status?we.success("验证成功"):!0===t.status?(Te.value=!1,Ue(t,!0)):se(t,e.data,De)})(e)},{default:x(()=>[...a[14]||(a[14]=[k("验证",-1)])]),_:2},1032,["onClick"])])):S("",!0)])):S("",!0)],64))),256))])]),"footer-right":x(()=>[w(Pe)?S("",!0):(_(),j(z,{key:0,type:"default",onClick:Me},{default:x(()=>[...a[15]||(a[15]=[k("验证",-1)])]),_:1}))]),_:1}),f(K,{list:w(Je),listStyle:"disc",class:"ml-[20px]"},null,8,["list"])])]),_:1},8,["modelValue","title"])])}}});export{_e as default};
