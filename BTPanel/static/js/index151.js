import{u as a,a5 as e,ck as s,w as l,bX as t,aH as o,ai as n,M as r,l as i,L as u,aq as d,bv as p,j as c,ag as m,_ as v,H as g,c as w,h as _,e as h}from"./utils-lib.js?v=1756369731";import{_ as f}from"./index116.js?v=1756369731";import{j as b,s as j,g as y,r as k,k as x,c as V,p as C,a4 as P,G as q,H as S,x as T,q as U,v as O,e as E,A as D,M,C as I,y as R,B as F,F as H,a_ as L,z as N,Q as J,P as z,a9 as K,S as A,ai as B,aj as X,a7 as Q}from"./base-lib.js?v=1756369731";import{_ as W}from"./index101.js?v=1756369731";import{z as Y,f as $,ax as G,ay as Z,az as aa,k as ea,aA as sa,aB as la,aC as ta,aD as oa,aE as na,aF as ra}from"./validator.js?v=1756369731";import{b as ia}from"./useController11.js?v=1756369731";const ua=b("SOFT-DEPLOY-PROJECT-STORE",()=>{const{panel:c}=a(),{rowData:m,oneDeploy:v}=j(Y()),g=y(()=>m.value),w=y(()=>{var a;return(null==(a=g.value)?void 0:a.install_type)?"php_async":e(g.value.project_type)?1===g.value.project_type?"java":"php":g.value.project_type||"php"}),_=k(!1),h=k(!1),f=k(""),b=k([]),V=k(),C=k(),P=k([]),q=k(null),S=k(),T=k(!1);let U=!1;const O=()=>(new Date).getTime().toString().substring(7),E=x({webname:"",ps:"",path:s("sites_path")||"/www/wwwroot",datauser:"sql".concat(O()),datapassword:"".concat(l(10)),code:"",version:"",project_jdk:""});k("/www/wwwroot");let D="/www/wwwroot/";const M={webname:[{required:!0,message:"请输入域名",trigger:"blur"},{validator:(a,e,s)=>{const l=e.split("\n").filter(a=>a.length),n=l.findIndex(a=>a.split(":")[0].length<3);l.map((a,e)=>{let l=a.includes(":");(l&&!t(a)||!l&&!o(a))&&s(new Error("当前域名格式错误，第".concat(e+1,"行，内容:").concat(a)))}),-1!==n?s(new Error("第 ".concat(n+1," 个域名长度不符合要求（必须大于3个字符）"))):s()},trigger:["blur","change"]}],ps:[{validator:(a,e,s)=>{e.replace(/[^\x00-\xff]/g,"**").length>20&&(E.ps=e.substring(0,20),s(new Error("不要超出20个字符"))),""===e?s(new Error("请输入备注")):s()},trigger:["blur"]}],datauser:[{validator:(a,e,s)=>I(e,s,"请输入数据库用户名"),trigger:["blur"]}],datapassword:[{validator:(a,e,s)=>I(e,s,"请输入数据库密码"),trigger:["blur"]}],project_jdk:[{validator:(a,e,s)=>I(e,s,"请选择JDK版本"),trigger:["blur","change"]}]},I=(a,e,s)=>{""===a&&"java"===w.value?e(new Error(s)):e()},R=x({title:"",databaseName:"",user:"",password:"",domain:""}),F=async(a=!1)=>{var e,s;if(E.code=g.value.title,"java"===w.value){const a=(null==(s=null==(e=g.value)?void 0:e.java)?void 0:s.split(","))||g.value.php.split(","),{data:l}=await G();P.value=l.jdk_info.filter(e=>a.includes(e.name)).map(a=>({title:"".concat(a.name).concat(a.path?"[".concat(a.path,"]"):""),key:a.path||a.name,disabled:!a.path}));const t=P.value.filter(a=>!a.disabled);E.project_jdk=t.length?t[0].key:""}else{const a=await Z();if(a.status){const e=g.value.php.replace(/\./g,"").split(","),s=a.data.filter(a=>e.includes(a.version));if(0===s.length){const a=await v.value;return null==a||a.unmount(),void r.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:"缺少被支持的PHP版本，请安装!",type:"error",duration:0,showClose:!0})}s.filter(a=>"00"!==a.version).forEach(a=>{b.value.push({label:a.name,value:a.version})}),E.version=b.value[0].value}else r.error(a.msg);g.value.enable_functions.length>2&&r.warn({msg:"注意：部署此项目，以下函数将被解禁:".concat(g.value.enable_functions),time:3e3})}a&&r.success("JDK版本，刷新成功")},H=async a=>{q.value=setTimeout(async()=>{!T.value&&await(async()=>{try{const{msg:a}=await sa();f.value=a,-1!==a.indexOf("ERROR：")&&(T.value=!0,clearTimeout(q.value)),H()}catch(a){}})()},1e3)},L=()=>{var a,e;const s=null==(a=c.value)?void 0:a.sitePath;if(s){const a=p(s,"string","");E.path=a,D=null==(e=a+"/")?void 0:e.replace(/\/\//g,"/")}};return{projectType:w,options:b,loading:_,logPopup:h,logContent:f,quickFormRef:V,quickForm:E,quickRules:M,checkInfo:C,javaOptions:P,speedTimer:q,speedLoading:S,deployMsg:R,changeName:a=>{var e,s;E.webname=a;const l=n(a)?null==a?void 0:a.split("\n"):[a.toString()];U||(E.path="".concat(null==D?void 0:D.replace(/\/\//g,"/")).concat(null==(e=l[0])?void 0:e.replace(/\W/g,"_"))),E.ps=l[0],E.datauser="".concat(null==(s=l[0])?void 0:s.replace(/\W/g,"_"))},onPathChange:()=>{$({type:"dir",change:a=>{U=!0,E.path=a}})},clearSpace:a=>{E.VOLUME_PATH=E.VOLUME_PATH.replace(/\s+/g,"")},selectVersion:a=>{E.version=a},getForm:F,onConfirm:async()=>{var a;if(!(null==(a=C.value)?void 0:a.mysql)&&"java"===w.value)return r.error("请先安装数据库");await V.value.validate(),T.value=!1;const e=E.webname.split("\n"),s=e[0].split(":")[0],l=await(async()=>{var a,e,s,l;const{webname:t,ps:o,path:n,datauser:i,datapassword:u,version:d,project_jdk:p}=E,c=t.split("\n").map(a=>a.trim()).filter(Boolean),m=c[0].split(":")[1]||"80",v=JSON.stringify({domain:c[0],domainlist:c.slice(1),count:c.length});let _="";if("java"===w.value){const a=r.load("正在获取项目jar包路径"),e=await la({dname:g.value.name,sitename:c[0]});if(a.close(),!e.status)return r.error(e.msg),!1;_=e.msg}const h={php:{webname_1:c[0],ps:g.value.name+"一键部署",path:n,version:d,port:m,webname:v,ftp:!1,sql:!0,datauser:i,datapassword:u,address:"localhost",codeing:"utf8mb4"},php_async:{site_path:n,project_cmd:null==(e=null==(a=g.value)?void 0:a.config)?void 0:e.run_server,install_dependence:0,php_version:d,sql:"MYSQL",project_ps:g.value.name+"一键部署",open_proxy:0,project_proxy_path:"",run_user:"www",composer_version:"",sql_user:i,sql_pwd:u,sql_codeing:"utf8mb4",webname:v},java:{data:JSON.stringify({project_type:0,domains:c,project_jar:_,project_jdk:p,project_name:c[0].replace(/[:.]/g,"_"),project_cmd:(null==(l=null==(s=g.value)?void 0:s.config)?void 0:l.run_server)||"".concat(p," -jar -Xmx1024M -Xms256M ").concat(_),project_ps:g.value.name+"一键部署",run_user:"root",env_file:"",env_list:[],jmx_status:!1,watch_file:!1,ps:g.value.name+"一键部署",by_process:0})}};return h[w.value]||h.php})();if(!l)return;const t={default:ta,php_async:oa,java:na},o=t[w.value]||t.default;let n=r.load("正在准备部署, 请稍后...");const d=await o(l);if(n.close(),!d.status)return r.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:d.msg,type:"error",duration:0,showClose:!0}),d.status;var p;"java"===w.value?(R.databaseName="",R.user="",R.password=""):d.data&&(p=d.data,R.title="数据库账号资料",p.databaseStatus?(R.databaseName=p.databaseUser,R.user=p.databaseUser,R.password=p.databasePass):(p.databaseUser?R.databaseName="数据库【"+p.databaseUser+'】<span class="text-danger">创建失败</span>，请检查是否存在同名数据库!':R.databaseName="数据库创建失败，检查是否存在同名数据库!",R.user="",R.password="")),h.value=!0,f.value="",H();const c={dname:g.value.name,site_name:s,project_type:w.value};"java"===w.value?(c.project_name=e[0].replace(/[:.]/g,"_"),c.datauser=E.datauser,c.datapassword=E.datapassword):c.php_version=E.version;const m=await aa(c);return n.close(),clearInterval(q.value),!T.value&&(m.status?(((a,e)=>{var s,l,t;(a.admin_username||(null==(s=null==a?void 0:a.config)?void 0:s.admin_username))&&(R.title="已成功部署，无需安装，请登录修改默认账号密码",R.user=a.admin_username||(null==(l=null==a?void 0:a.config)?void 0:l.admin_username),R.password=a.admin_password||(null==(t=null==a?void 0:a.config)?void 0:t.admin_password)),R.domain=(e+"/"+((null==a?void 0:a.success_url)||"")).replace("//","/")})(m.data,s),i({title:"部署成功",area:64,component:()=>u(()=>import("./success-popup.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),showClose:!0}),m.status):(r.msg({customClass:"bt-message-error-html",dangerouslyUseHTMLString:!0,message:m.msg,type:"error",duration:0,showClose:!0}),!1))},getDefaultPath:L,init:async()=>{_.value=!0;try{await(async()=>{try{const{data:a}=await ra();C.value=a}catch(a){}})(),F(),L()}catch(a){}finally{_.value=!1}},installPlugin:async a=>{const{data:e}=await d({sName:a});ea({name:e.name,type:"i",pluginInfo:e})},openView:()=>{window.open("http://"+R.domain,"_blank","noopener,noreferrer")},$reset:()=>{clearInterval(q.value),b.value=[],C.value=null,P.value=[],h.value=!1,Object.assign(E,{webname:"",ps:"",path:s("sites_path")||"/www/wwwroot",datauser:"sql".concat(O()),datapassword:"".concat(l(10)),code:"",version:"",project_jdk:""})}}}),da={class:"flex flex-col p-[16px] lib-box"},pa={class:"flex items-center"},ca={key:0,class:"text-[1.2rem] mt-1rem text-danger"},ma={class:"flex items-center custom-refresh-select"},va={class:"el-input-group__append !h-3rem !flex items-center"},ga={class:"helpTip block mt-1rem leading-[16px]"},wa=h(V({__name:"index",setup(a,{expose:e}){const s=ua(),{quickRules:l,init:t,installPlugin:o,onConfirm:n,getForm:r,onPathChange:i,changeName:u,clearSpace:d,selectVersion:p,$reset:h}=s,{projectType:b,options:y,loading:k,logPopup:x,logContent:V,quickFormRef:Y,quickForm:$,checkInfo:G,javaOptions:Z}=j(s);return C(t),P(h),e({onConfirm:n}),(a,e)=>{const s=c,t=K,n=W,h=A,j=m,C=B,P=X,aa=v,ea=g,sa=w,la=Q,ta=f,oa=_,na=q("bt-loading");return S((U(),O("div",da,[E(la,{ref_key:"quickFormRef",ref:Y,size:"small",model:T($),rules:T(l),class:"relative w-full p-[1.5rem]","label-position":"right",onSubmit:e[13]||(e[13]=J(()=>{},["prevent"]))},{default:D(()=>[E(t,{prop:"webname",label:"域名"},{default:D(()=>[E(s,{width:"32rem",rows:3,type:"textarea",modelValue:T($).webname,"onUpdate:modelValue":e[0]||(e[0]=a=>T($).webname=a),placeholder:"每行填写一个域名，默认为80端口\n泛解析添加方法 *.domain.com\n如另加端口格式为 www.domain.com:88",onInput:T(u)},null,8,["modelValue","onInput"])]),_:1}),"java"!==T(b)?(U(),M(t,{key:0,prop:"path",label:"根目录"},{default:D(()=>[E(n,{modelValue:T($).path,"onUpdate:modelValue":e[1]||(e[1]=a=>T($).path=a),name:"path",icon:"el-folder-opened",onIconClick:e[2]||(e[2]=a=>T(i)()),onChangePassive:e[3]||(e[3]=a=>T(d)("path")),width:"32rem"},null,8,["modelValue"])]),_:1})):I("",!0),E(t,{label:"数据库"},{default:D(()=>{var a;return[R("div",pa,[E(t,{prop:"datauser",class:"!mb-0"},{default:D(()=>[E(s,{width:"15rem",modelValue:T($).datauser,"onUpdate:modelValue":e[4]||(e[4]=a=>T($).datauser=a),placeholder:"数据库用户名"},null,8,["modelValue"])]),_:1}),E(t,{prop:"datapassword",class:"datapassword !mb-0"},{default:D(()=>[E(s,{width:"15rem",class:"ml-[1rem]",modelValue:T($).datapassword,"onUpdate:modelValue":e[5]||(e[5]=a=>T($).datapassword=a),placeholder:"数据库密码"},null,8,["modelValue"])]),_:1}),(null==(a=T(G))?void 0:a.mysql)?I("",!0):(U(),O("div",ca,[e[15]||(e[15]=F("未安装数据库 ",-1)),R("span",{class:"bt-link",onClick:e[6]||(e[6]=a=>T(o)("mysql"))},"立即安装")]))])]}),_:1}),E(t,{prop:"port",label:"源码"},{default:D(()=>[E(h,{class:"!w-[15rem]",modelValue:T($).code,"onUpdate:modelValue":e[7]||(e[7]=a=>T($).code=a),disabled:""},null,8,["modelValue"]),e[16]||(e[16]=R("span",{class:"helpTip"},"准备为你部署的源码程序",-1))]),_:1}),"java"!==T(b)?(U(),M(t,{key:1,prop:"port",label:"PHP版本"},{default:D(()=>[E(j,{modelValue:T($).version,"onUpdate:modelValue":e[8]||(e[8]=a=>T($).version=a),options:T(y),class:"!w-[10rem]",onChange:T(p)},null,8,["modelValue","options","onChange"]),e[17]||(e[17]=R("span",{class:"helpTip"},"请选择源码程序支持的php版本",-1))]),_:1})):(U(),M(t,{key:2,label:"JDK版本",prop:"project_jdk"},{default:D(()=>[R("div",ma,[E(P,{size:"small",modelValue:T($).project_jdk,"onUpdate:modelValue":e[10]||(e[10]=a=>T($).project_jdk=a),onChange:T(p),class:"!w-[32rem]",placeholder:"请选择JDK版本"},{default:D(()=>[(U(!0),O(H,null,L(T(Z),a=>(U(),M(C,{key:a.key,label:a.title,value:a.key,disabled:a.disabled},{default:D(()=>[R("span",null,N(a.title),1),a.disabled?(U(),O(H,{key:0},[e[18]||(e[18]=F(" [",-1)),R("span",{class:"my-4px bt-link",onClick:e[9]||(e[9]=a=>T(ia)("jdkSettings"))},"未安装"),e[19]||(e[19]=F("] ",-1))],64)):I("",!0)]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","onChange"]),R("div",va,[E(ea,{title:"刷新JDK版本",class:"!flex",onClick:e[11]||(e[11]=a=>T(r)(!0))},{default:D(()=>[E(aa,{icon:"el-refresh",class:"!text-[14px]"})]),_:1})])]),R("span",ga,[e[21]||(e[21]=F(" 请选择源码程序支持的JDK版本 ",-1)),E(sa,{onClick:e[12]||(e[12]=a=>T(ia)("jdkSettings"))},{default:D(()=>[...e[20]||(e[20]=[F("安装其他版本",-1)])]),_:1})])]),_:1}))]),_:1},8,["model","rules"]),E(oa,{title:"部署日志",modelValue:T(x),"onUpdate:modelValue":e[14]||(e[14]=a=>z(x)?x.value=a:null),area:53},{default:D(()=>[E(ta,{class:"h-[40rem] !rounded-none",content:T(V)},null,8,["content"])]),_:1},8,["modelValue"])])),[[na,T(k)]])}}}),[["__scopeId","data-v-4b2a6002"]]),_a=Object.freeze(Object.defineProperty({__proto__:null,default:wa},Symbol.toStringTag,{value:"Module"}));export{ua as S,_a as i};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
