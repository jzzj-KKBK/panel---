import{r as e,o as a,g as t,e as l,ar as s,c as r,ay as n,Z as o,w as i,B as c,q as u,v as d,y as p,A as m,F as f,a_ as h,x as v,K as g,z as _,Q as y,aj as w,D as b,aQ as x,M as T,ai as k,bI as j,p as P}from"./base-lib.js?v=1756369731";import"./file-icon.js?v=1756369731";import{K as I,f7 as N,o as L,f8 as S,l as C,L as R,G as z,b as D,ah as E,f9 as q,fa as A,aj as O,fb as V,u as B,v as F,a6 as H,e as J}from"./utils-lib.js?v=1756369731";import{a as K,u as M}from"./column.js?v=1756369731";import{b as Q}from"./form-item.js?v=1756369731";import{V as G}from"./store.js?v=1756369731";import{_ as U}from"./index103.js?v=1756369731";import{F as W}from"./files-path.js?v=1756369731";import{u as Z}from"./useStore9.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";import"./files.js?v=1756369731";import"./validator.js?v=1756369731";import"./store2.js?v=1756369731";import"./index101.js?v=1756369731";const X=D(),Y=e(null),$=a(()=>{X.error("不能直接上传文件到系统根目录!")},2e3),ee=(e,a,t,l)=>{var s,r;if(e.preventDefault(),"/"!==a){if(null==(s=null==e?void 0:e.dataTransfer)?void 0:s.items){Array.from(null==(r=null==e?void 0:e.dataTransfer)?void 0:r.items).some(e=>"file"===e.kind)&&(Y.value||ae(a,t,l))}}else $()},ae=(e,a,t)=>{"/"!==e?Y.value=C({title:"上传文件到【".concat(e,"】"),area:"72",component:()=>R(()=>import("./node-upload.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),compData:{path:e,nodeId:a,refresh:t},onCancel:()=>{t(),Y.value=null}}):X.error("不能直接上传文件到系统根目录!")},te=(e,a)=>{const t="node_file_path_".concat(e);if(void 0!==a)return localStorage.setItem(t,a),a;return localStorage.getItem(t)||"/"},le=({lpver:e})=>!!e;let se=null;const re=async(a,t=!1)=>{const l=e({source_path:"",target_path:"",target_node:"",source_node:"",file_count:0,file_complete:0,file_error:0,fileList:[]});let s=null;const r=async()=>{s=await C({title:"文件传输日志",area:75,component:()=>R(()=>import("./index354.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),compData:l,onCancel:()=>{null==se||se.close(),s=null},btns:!1})},n=async()=>{let a=0,t=0;const s=[],r=[];l.value.fileList.forEach(e=>{"complete"===e.status?(a++,r.push(e)):(t++,s.push(e))}),C({title:"文件传输结果",area:45,component:()=>R(()=>import("./transfer-result.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),compData:{success:a,fail:t,sendList:e([...s,...r])}})};null==se||se.close(),se=E({route:"/ws_modsoc",onMessage:(e,o)=>{const i=JSON.parse(o.data);if("end"===i.type)return null==se||se.close(),s&&s.unmount(),void(t||(l.value={...i.task,fileList:i.file_status_list},n(),X.success("文件传输完成"),a()));"error"===i.type&&X.error(i.msg),s||r(),i.task&&(l.value={...i.task,fileList:i.file_status_list})}}),null==se||se.send({mod_name:"node",sub_mod_name:"file_transfer",def_name:"transfer_status",callback:"xxxxxxo",data:{}})},ne=async e=>new Promise((a,t)=>{C({title:"文件传输",area:45,component:()=>R(()=>import("./transfer-confirm.js?v=1756369731"),__vite__mapDeps([]),import.meta.url),btn:!0,compData:{...e,complete:e=>{a(e)}},onCancel:()=>{t(!1)}})}),oe=async(e,a,s)=>{let r=null;const{BtForm:n,submit:o}=z({data:()=>({name:""}),options:e=>t(()=>[Q("名称","name",{attrs:{class:"!w-[23rem]",placeholder:"请输入文件夹名称",onkeydown:async e=>{if("Enter"===e.key){e.preventDefault(),e.stopPropagation();await o()&&(null==r||r.unmount())}}},rules:[{required:!0,message:"请输入文件夹名称"},{validator:(e,a,t)=>{RegExp(/[\*\|\:\\\"\/\<\>\?]+/).test(a)?t(new Error("文件夹名称不能包含特殊字符")):t()},trigger:["blur","change"]}]})]),submit:async(t,l,r)=>{try{return await l(),await(async t=>{try{return await I({message:!0,loading:"创建中...",request:q({node_id:a.toString(),path:"".concat(e,"/").concat(t.value.name).replace(/\/\//g,"/")})}),!0}catch(l){return!1}finally{s()}})(t)}catch(n){return!1}}});r=await C({title:"新建文件夹【".concat(e,"】"),area:45,component:()=>l("div",{class:"p-[2rem]"},[l(n,null,null)]),btn:!0,onConfirm:o})},ie={class:"flex items-center mb-[1.6rem]"},ce={class:"flex flex-col !h-[5rem] pt-[1rem]"},ue={class:"mb-0 leading-[1.2rem] !vertical-middle"},de={class:"text-[#999] text-[1rem]"},pe={class:"flex items-center gap-3"},me={class:"flex items-center gap-3"},fe={class:"text-[#999]"},he=r({__name:"files-list-card",props:{panelType:{type:String,required:!0}},setup(a,{expose:t}){const j=a,{mainHeight:P}=B(),{currentNodes:C}=Z(),R=e([]),z=n("nodeList",e([])),D=n("createTask",(e,a,t)=>{}),E=e([]),q=e(te(C.value[j.panelType]));o("currentPath",q);const V=e({p:1,showRow:200,path:s(q),search:""}),J=e=>{switch(j.panelType){case"source":return e===C.value.target;case"target":return e===C.value.source}},Q=e=>{E.value=e?z.value.filter(a=>a.label.includes(e)||a.server_ip.includes(e)):z.value};i(z,e=>{E.value=e}),i(()=>C.value[j.panelType],()=>{X(),ve.value.limit=100,_e(te(C.value[j.panelType])),ne()});const X=()=>{const e=C.value[j.panelType];e&&localStorage.setItem("fileTransfer_".concat(j.panelType,"_nodeId"),e)},Y=[K({key:"vid"}),{label:"文件名称",prop:"name",minWidth:200,showOverflowTooltip:!0,render:e=>l("div",{class:"flex items-center files-list"},[l("i",{class:"icon-bg ".concat(["zip","rar","7z","gz","tar.gz","tgz","war"].includes(e.ext)?"compress":e.ext,"-icon")},null),l("span",{onClick:()=>ye(e),class:"cursor-pointer hover:text-primary truncate ml-[4px] fileName ".concat(e.isReName?"hidden":""),title:e.fileName+e.isLink},[e.fileName+e.isLink])])},{label:"文件大小",prop:"size",width:120,render:e=>"folder"===e.ext?l(xe,{row:e},null):F(e.size)},M([{title:"source"===j.panelType?"发送到右侧":"发送到左侧",width:100,onClick:e=>we(e)},{title:"删除",onClick:e=>(async(e,a)=>{await L({title:"删除文件",content:'确定要删除文件 "'.concat(e.fileName,'" 吗？')}),await I({message:!0,loading:"删除中...",request:S({node_id:e.nodeId,path:e.path,is_dir:e.isFile?0:1})}),a()})(e,ne)}])],{BtTable:$,BtSearch:le,BtPage:se,BtColumn:re,refresh:ne,ref:he,param:ve}=H({request:async({p:e,limit:a,search:t})=>{const l=await(async({nodeId:e,path:a,p:t,showRow:l,search:r})=>{if(!e)return{data:[]};try{const n=await I({request:A({p:t,showRow:l,node_id:e,path:a,search:r})}),{data:o}=n,{path:i,dir:c,files:u,bt_sync:d,tamper_data:p}=o,{dirs:m,files:f,msg:h}=p||{dirs:[],files:[],msg:""},v=new Array(c.length+u.length);let g=0;for(let a=0;a<c.length;a++)v[g++]={...G("dir",c[a],h?"":m[a],i,d),vid:"dir".concat(g),nodeId:e,loading:s(!1)};for(let a=0;a<u.length;a++)v[g++]={...G("file",u[a],h?"":f[a],i),vid:"file".concat(g),nodeId:e};return{data:v,total:O(o.page),path:i}}catch(n){return{data:[],path:a}}})({nodeId:C.value[j.panelType],path:V.value.path,p:e,showRow:a,search:t});return te(C.value[j.panelType],l.path),_e(l.path),he.value.clearAllSelect(),l},columns:Y,extension:[]}),ge=async e=>{_e(e),ne()},_e=e=>{switch(q.value=e,j.panelType){case"source":C.value.sourcePath=e;break;case"target":C.value.targetPath=e}},ye=e=>{e.isFile||(q.value="".concat(e.path),ne())},we=async e=>{try{const a="all"===e?R.value:[e];D(j.panelType,a,()=>{he.value.clearAllSelect()})}catch(a){he.value.clearAllSelect()}},be=e=>{R.value=e},xe=r({props:{row:{type:Object,required:!0}},setup:e=>()=>l("a",{class:"flex items-center",title:"点击计算大小",onClick:()=>(async e=>{if(!e.loading&&!e.dirSize)try{e.loading=!0;const{data:a}=await I({request:N({node_id:e.nodeId,path:e.path})});e.dirSize=a.size,e.loading=!1}catch(a){e.loading=!1}})(e.row)},[e.row.loading&&l("span",{class:"svgtofont-el-loading animate-spin mr-2px"},null),e.row.loading&&l("span",{class:""},[c("计算中")]),!e.row.loading&&l("div",{class:"text-primary cursor-pointer"},[void 0===e.row.dirSize?"计算":e.row.dirSize])])});return t({refresh:ne}),(e,a)=>{const t=k,s=w,r=b,n=x;return u(),d("div",{class:"rounded-[.5rem] module-ui shadow-[0 1px 3px 1px rgba(0, 0, 0, 0.05)]",onDragenter:a[4]||(a[4]=y(()=>{},["prevent"])),onDragover:a[5]||(a[5]=y(e=>v(ee)(e,v(q),v(C)[j.panelType],v(ne)),["prevent"]))},[p("div",ie,[l(s,{class:"!w-[16rem] mr-[1.6rem]",modelValue:v(C)[j.panelType],"onUpdate:modelValue":a[0]||(a[0]=e=>v(C)[j.panelType]=e),filterable:"","filter-method":Q,onChange:e.handleNodeChange},{default:m(()=>[(u(!0),d(f,null,h(v(E),e=>(u(),T(t,{class:"!h-[5rem]",key:e.value,label:e.label,value:e.value,disabled:J(e.value)},{default:m(()=>[p("div",ce,[p("span",ue,_(e.label),1),p("span",de,_(e.server_ip),1)])]),_:2},1032,["label","value","disabled"]))),128))]),_:1},8,["modelValue","onChange"]),l(W,{initialPath:v(q),onPathChange:ge,onRefresh:v(ne)},null,8,["initialPath","onRefresh"])]),l(v(U),null,{"header-left":m(()=>[l(r,{type:"primary",onClick:a[1]||(a[1]=e=>v(ae)(v(q),v(C)[j.panelType],v(ne)))},{default:m(()=>[...a[6]||(a[6]=[c(" 上传文件 ",-1)])]),_:1}),l(r,{type:"default",onClick:a[2]||(a[2]=e=>v(oe)(v(q),v(C)[j.panelType],v(ne)))},{default:m(()=>[...a[7]||(a[7]=[c(" 新建文件夹 ",-1)])]),_:1})]),"header-right":m(()=>[p("div",pe,[l(v(le),{placeholder:"请输入文件名称"})])]),content:m(()=>[l(v($),{style:g("height:".concat(v(P)-290,"px")),onSelectionChange:be},null,8,["style"])]),"footer-left":m(()=>[p("div",me,[l(n,{content:"请先选择文件",placement:"top",disabled:v(R).length>0},{default:m(()=>[l(r,{type:"primary",disabled:0===v(R).length,onClick:a[3]||(a[3]=e=>we("all"))},{default:m(()=>[c("发送到"+_("source"===j.panelType?"右侧":"左侧"),1)]),_:1},8,["disabled"])]),_:1},8,["disabled"]),p("span",fe,"当前选中"+_(v(R).length)+"个文件",1)])]),"footer-right":m(()=>[l(v(se),{layout:"prev, pager, next"})]),_:1})],32)}}}),ve={class:"file-transfer"},ge={class:"transfer-container"},_e={class:"transfer-panel left-panel"},ye={class:"transfer-panel right-panel"},we=J(r({__name:"index",setup(a){const{getNodeList:t,currentNodes:r}=Z(),n=D(),i=e([]);o("nodeList",i);const c=j("leftPanelRef"),m=j("rightPanelRef"),f=async()=>{const e=await t();i.value=(e=>e.map(e=>({...e,isLocal:"local"===e.api_key&&"local"===e.app_key,label:e.remarks,value:e.id})))(e.data);const a=Number(localStorage.getItem("fileTransfer_source_nodeId")),l=Number(localStorage.getItem("fileTransfer_target_nodeId"));let s=null,n=null,o=null;for(let t=0;t<i.value.length;t++)i.value[t].isLocal?(o=i.value[t].id,r.value.localNodeId=o):n||(n=i.value[t].id),i.value[t].id===a&&(s=i.value[t].id),i.value[t].id===l&&(n=i.value[t].id);s||(s=o),r.value.source=s,r.value.target=n};return o("refreshNodeList",f),o("createTask",async(e,a,t)=>{const l=r.value[e],o=r.value["source"===e?"target":"source"];let u=null,d=null;for(let s=0;s<i.value.length&&(i.value[s].id===l&&(u=i.value[s]),i.value[s].id===o&&(d=i.value[s]),!u||!d);s++);if(!d)return n.error("请选择目标节点"),void t();(async e=>{try{if(le(e.sourceNode)&&le(e.targetNode))return X.error("当前两节点均为1panel节点，无法创建文件分发任务"),void e.callback();const a=await ne(e),t=await I({message:!0,loading:"创建传输任务...",request:V({source_node_id:e.sourceNode.id,target_node_id:e.targetNode.id,source_path_list:JSON.stringify(e.sourcePathList.value.map(e=>({path:e.path,is_dir:!e.isFile,size:e.size}))),target_path:e.targetPath,default_mode:a})});e.callback(),t.status&&re(e.complete)}catch(a){e.callback()}})({sourceNode:u,targetNode:d,sourcePathList:s(a),targetPath:r.value["source"===e?"targetPath":"sourcePath"],callback:t,complete:()=>{var a,t;"source"===e?null==(a=m.value)||a.refresh():null==(t=c.value)||t.refresh()}})}),P(()=>{f(),re(()=>{},!0)}),(e,a)=>(u(),d("div",ve,[p("div",ge,[p("div",_e,[l(he,{ref_key:"leftPanelRef",ref:c,"panel-type":"source"},null,512)]),p("div",ye,[l(he,{ref_key:"rightPanelRef",ref:m,"panel-type":"target"},null,512)])])]))}}),[["__scopeId","data-v-358159e0"]]);export{we as default};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
