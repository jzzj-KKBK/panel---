var e,a;import{K as t,M as l,at as s,o as n,v as o,u as r,G as u,j as i,bg as c,bV as p,l as m,h as d}from"./utils-lib.js?v=1756369731";import{j as v,r as g,k as y,c as f,g as h,e as w,T as x,B as b,p as _,q as V,v as j,x as k,y as C,P as S,C as z,A as E,F as N,z as T,K as U,ai as L,aj as O,D as J,ax as q,a$ as I}from"./base-lib.js?v=1756369731";import{_ as B}from"./index101.js?v=1756369731";import{_ as M}from"./index116.js?v=1756369731";import{m as $}from"./form-item.js?v=1756369731";import{f as G}from"./validator.js?v=1756369731";import{u as H}from"./useStore4.js?v=1756369731";import{changeProjectPath as P,mamgerLogSplit as R,getProjectLogs as F,setLogSplit as K,getLogSplit as A,setProjectLogStatus as D}from"./site.js?v=1756369731";const Q=v("SITE-PROJECT-LOG-STORE",()=>{const{siteInfo:e,siteType:a}=H();return{getLogEvent:async e=>{try{const{data:t}=await F(e,a.value);return{data:t,status:!0}}catch(t){return{status:!1,msg:"获取日志失败"}}},savePathEvent:async e=>{try{const l=await t({loading:"正在保存日志配置，请稍后...",request:P(e,a.value),message:!0});return{status:l.status,msg:l.msg}}catch(l){return{status:!1,msg:"保存日志路径失败"}}},saveSplitTaskEvent:async e=>{try{const l=await t({loading:"正在设置日志切割任务，请稍后...",request:R(e,a.value),message:!0});return{status:l.status,msg:l.msg}}catch(l){return{status:!1,msg:"保存日志切割配置失败"}}},setLogSplitEvent:async(e,t=!0)=>{let n;try{n=l.load("正在设置日志切割任务，请稍后...");const s=await K(e,a.value);return t&&l.request(s),s}catch(o){s(o)}finally{null==n||n.close()}},getLogSplitEvent:async e=>{try{const{data:t}=await A(e,a.value);return{data:t,status:!0}}catch(t){return{status:!1,msg:"获取日志切割信息失败"}}}}}),{siteInfo:W,siteType:X,isRefreshList:Y}=H(),{savePathEvent:Z,setLogSplitEvent:ee,getLogSplitEvent:ae,saveSplitTaskEvent:te,getLogEvent:le}=Q(),se=g(!!(null==(a=null==(e=W.value)?void 0:e.project_config)?void 0:a.nohup_log)),ne=g(!1),oe=g(!1),re=g(null),ue=g(!1),ie=g(!1),ce=g("开启后默认每天2点0分进行切割日志文件，如需修改请点击"),pe=y({path:"",logs:"",type:"",split:!1,size:"",isNew:!1,isGunicorn:!1}),me=async()=>{t({loading:"正在设置控制台日志状态，请稍后...",request:D({project_name:W.value.name,status:se.value?1:0}),message:!0,success:e=>{e.status?Y.value=!0:se.value=!se.value}})},de=async()=>{try{const e=X.value,a={python:{data:JSON.stringify({name:W.value.name,data:{logpath:pe.path,loglevel:pe.type}})},default:{data:JSON.stringify({project_name:W.value.name,path:pe.path})}},t=await Z(a[e]||a.default);return t.status&&(W.value.project_config.log_path=pe.path,he()),t}catch(e){return{status:!1,msg:"保存日志路径失败"}}},ve=()=>{oe.value=!0,re.value=setInterval(()=>{he()},2e3)},ge=()=>{oe.value=!1,re.value&&clearInterval(re.value)},ye=async e=>{try{const{name:a}=W.value,t=["net"].includes(X.value);if("1"===e.type&&!Number(e.log_size))return l.error("请填写日志大小"),!1;if(!pe.split){let e={data:JSON.stringify({[t?"project_name":"name"]:a})};await ee(e,!1)}const s={data:JSON.stringify({[t?"project_name":"name"]:a,hour:e.hour.toString(),minute:e.minute.toString(),num:e.num.toString(),compress:e.compress,log_size:"1"===e.type?e.log_size:0})},n=await te(s);return n.status&&(ue.value=!1,we(),ue.value=!1),n.status}catch(a){return!1}},fe=async e=>{pe.split=!e;const a=["net"].includes(X.value);await n({title:"设置日志切割任务",content:"".concat(e?"开启后":"关闭后停止","对该项目日志进行切割，是否继续操作？")});let t={data:JSON.stringify({[a?"project_name":"name"]:W.value.name})};const s=pe.isNew?await te(t):await ee(t);pe.isNew||l.request(s),s.status&&(await we(),await he())},he=async()=>{var e;ne.value=!0;try{const a={python:{name:W.value.name},default:{project_name:W.value.name}},t=a[X.value]||a.default,{data:l}=await le(t);let s=null==(e=W.value.project_config)?void 0:e.log_path;pe.logs=l.data||"暂无日志信息",pe.path=l.path||s||"",pe.size=l.size||l.szie||"0B",ne.value=!1}catch(a){s(a)}finally{ne.value=!1}},we=async(e=X.value)=>{try{ne.value=!0;const{name:a}=W.value,t={net:{project_name:a,data:JSON.stringify({project_name:a})},python:{name:a},default:{data:JSON.stringify({name:a})}},{data:l}=await ae(t[e]||t.default);let s={hour:"2",minute:"0",num:"180",compress:!1,log_size:5,type:"0"};return l.status?(pe.isNew=!1,pe.split=!!l.data.status,s={hour:l.data.hour,minute:l.data.minute,num:l.data.num,compress:l.data.compress,log_size:o(l.data.log_size,!1,2,"MB"),type:l.data.log_size?"1":"0"},ce.value="开启后".concat("1"===s.type?"日志文件大小超过":"默认每天").concat("1"===s.type?s.log_size+"MB":"".concat(s.hour,"点").concat(s.minute,"分"),"进行切割日志文件，如需修改请点击")):(pe.isNew=!0,pe.split=!1),ne.value=!1,{data:s,status:l.status}}catch(a){return s(a),{data:{},status:!1}}finally{ne.value=!1}},xe=()=>{he()},be={class:"flex flex-col"},_e={key:0,class:"flex h-3.2rem items-center mb-1rem"},Ve={class:"flex items-center"},je={key:0},ke={class:"mt-[16px] flex items-center"},Ce={class:"mt-[16px] flex items-center"},Se={class:"ml-[8px]"},ze={key:0,class:"mt-[16px] leading-8 text-[1.2rem] list-disc ml-[20px]"},Ee={class:"mt-[16px]"},Ne={key:0,class:"mb-[16px]"},Te={class:"p-[12px] w-full flex items-start overflow-y-auto h-full"},Ue=["innerHTML"],Le={class:"p-2rem"},Oe={class:"flex items-center"},Je={class:"mt-[16px] flex items-center"},qe={class:"ml-[8px]"},Ie={class:"py-20x"},Be=f({__name:"index",setup(e,{expose:a}){const{mainHeight:t}=r(),{siteType:l,siteInfo:s}=H(),n=()=>{G({type:"dir",path:pe.path,change:e=>{pe.path=e}})},{BtForm:o,submit:v}=u({data:async()=>{const{data:e}=await we();return e},options:e=>h(()=>[{type:"radio",label:"切割方式",key:"type",options:[{label:"按日志大小",value:"1"},{label:"按执行周期",value:"0"}]},..."0"===e.value.type?[{type:"custom",render:()=>w(c,{label:"执行时间"},{default:()=>[w("div",{class:"flex items-center"},[w(i,{width:"18.6rem",modelValue:e.value.hour,"onUpdate:modelValue":a=>e.value.hour=a},{prepend:"每天",append:"时"}),w(i,{width:"12rem",modelValue:e.value.minute,"onUpdate:modelValue":a=>e.value.minute=a},{append:"分"})])]}),rules:{hour:[{validator:(a,t,l)=>{"0"!==e.value.type||/^(?:[01]?[0-9]|2[0-3])$/.test(t)?l():l(new Error("请输入0-23的整数"))},trigger:["blur","change"]}],minute:[{validator:(a,t,l)=>{"0"!==e.value.type||/^[0-5]?[0-9]$/.test(t)?l():l(new Error("请输入0-59的整数"))},trigger:["blur","change"]}]}}]:[$("日志大小","log_size","MB",{attrs:{style:"width: 24rem;"},rules:[{required:!0,message:"请输入日志大小",trigger:["blur","change"]},{validator:(e,a,t)=>{!/^\d+(\.\d+)?$/.test(a)||a<=0?t(new Error("请输入大于0的数")):t()},trigger:["blur","change"]}]})],{type:"custom",render:()=>w(c,{label:"保留最新",prop:"num"},{default:()=>[w(i,{type:"number",modelValue:e.value.num,"onUpdate:modelValue":a=>e.value.num=a,class:"!w-[24rem]"},{append:"份"})]}),rules:{num:[p({message:"请输入保留最新份数"}),{validator:(e,a,t)=>{/^(?:[1-9]\d{0,2}|1[01]\d{2}|1800)$/.test(a)?t():t(new Error("请输入1-1800的整数"))},trigger:["blur","change"]}]}},{type:"custom",render:()=>w(c,{label:" "},{default:()=>[w(x,{modelValue:e.value.compress,"onUpdate:modelValue":a=>e.value.compress=a},{default:()=>[b("切割后压缩日志")]})]})},..."java"===l.value?[{type:"button",label:" ",slots:"保存",attrs:{type:"primary",onClick:()=>{v()}}}]:[],{type:"help",options:[..."1"===e.value.type?[{content:"每5分钟执行一次"},{content:"【日志大小】：日志文件大小超过指定大小时进行切割日志文件"}]:[],{content:"【保留最新】：保留最新的日志文件，超过指定数量时，将自动删除旧的日志文件"}]}]),submit:async(e,a)=>(await a(),await ye(e.value))}),g=()=>{m({title:"配置日志切割任务",area:50,showFooter:!0,component:()=>w(o,{class:"p-2rem"},null),onConfirm:v})};return _(xe),a({init:xe}),(e,a)=>{var r,u;const i=L,c=O,p=B,m=J,v=q,y=I,f=d;return V(),j("div",be,["springboot"===(null==(u=null==(r=k(s))?void 0:r.project_config)?void 0:u.java_type)?(V(),j("div",_e,[a[8]||(a[8]=C("span",{class:"inline-block mr-[1rem]"},"控制台日志",-1)),w(k(x),{slot:"reference",modelValue:k(se),"onUpdate:modelValue":a[0]||(a[0]=e=>S(se)?se.value=e:null),onChange:k(me)},null,8,["modelValue","onChange"])])):z("",!0),C("div",Ve,[k(pe).isGunicorn?(V(),j("div",je,[a[9]||(a[9]=C("span",null,"日志级别",-1)),w(c,{class:"mx-[8px] w-[10rem]",modelValue:k(pe).type,"onUpdate:modelValue":a[1]||(a[1]=e=>k(pe).type=e)},{default:E(()=>[w(i,{label:"debug",value:"debug"}),w(i,{label:"info",value:"info"}),w(i,{label:"warning",value:"warning"}),w(i,{label:"error",value:"error"}),w(i,{label:"critical",value:"critical"})]),_:1},8,["modelValue"])])):z("",!0),a[11]||(a[11]=C("span",{class:"mr-[8px]"},"日志路径",-1)),w(p,{modelValue:k(pe).path,"onUpdate:modelValue":a[2]||(a[2]=e=>k(pe).path=e),icon:"el-folder-opened",onIconClick:n,width:"38rem"},null,8,["modelValue"]),w(m,{class:"ml-[8px]",type:"primary",onClick:k(de)},{default:E(()=>[...a[10]||(a[10]=[b("保存",-1)])]),_:1},8,["onClick"])]),"java"!==k(l)?(V(),j(N,{key:1},[C("div",ke,[a[12]||(a[12]=C("span",{class:"mr-[8px]"},"日志大小",-1)),C("span",null,T(k(pe).size),1)]),C("div",Ce,[w(v,{placement:"bottom",width:"200","popper-class":"green-tips-popover",trigger:"hover"},{reference:E(()=>[w(k(x),{modelValue:k(pe).split,"onUpdate:modelValue":a[3]||(a[3]=e=>k(pe).split=e),size:"small",onChange:k(fe)},{default:E(()=>[...a[13]||(a[13]=[b("日志切割",-1)])]),_:1},8,["modelValue","onChange"])]),default:E(()=>[a[14]||(a[14]=C("span",{class:"p-[8px] inline-block"},"当日志文件过大时，读取和搜索时间会增加，同时也会占用存储空间，因此需要对日志进行切割以方便管理和维护。",-1))]),_:1}),C("span",Se,[b(T(k(ce)),1),C("span",{class:"bt-link",onClick:g},"编辑配置")])]),"java"===k(l)?(V(),j("ul",ze,[...a[15]||(a[15]=[C("li",null,"修改日志路径会重启项目",-1),C("li",null,"Tomcat内置项目，修改日志路径会对当前版本Tomcat的所有站点生效，不能单独设置",-1)])])):z("",!0)],64)):z("",!0),C("div",Ee,["java"===k(l)?(V(),j("div",Ne,[w(m,{onClick:k(he)},{default:E(()=>[...a[16]||(a[16]=[b("刷新日志",-1)])]),_:1},8,["onClick"]),w(m,{type:"default",onClick:k(ve)},{default:E(()=>[...a[17]||(a[17]=[b("实时日志",-1)])]),_:1},8,["onClick"]),w(y,{direction:"vertical"}),w(m,{type:"default",onClick:a[4]||(a[4]=e=>ie.value=!0)},{default:E(()=>[...a[18]||(a[18]=[b("日志切割设置",-1)])]),_:1})])):z("",!0),w(M,{content:k(pe).logs,isHtml:!0,fullScreen:{title:"全屏查看【项目】日志",onRefresh:k(he)},style:U({height:"java"===k(l)?"46rem":"54rem",width:"99.5%"})},null,8,["content","fullScreen","style"])]),w(f,{title:"查看日志",onCancel:k(ge),modelValue:k(oe),"onUpdate:modelValue":a[5]||(a[5]=e=>S(oe)?oe.value=e:null),area:["100%","100%"],"close-btn":2},{default:E(()=>[C("div",{class:"bg-[#333] text-white w-full h-full",style:U("height: ".concat(k(t),"px;"))},[C("pre",Te,[a[19]||(a[19]=b("\t\t\t\t\t",-1)),C("code",{class:"flex-1 w-full p-0 bg-none whitespace-pre-line text-i text-[#ececec]",innerHTML:k(pe).logs},null,8,Ue),a[20]||(a[20]=b("\n\t\t\t\t",-1))])],4)]),_:1},8,["onCancel","modelValue"]),w(f,{title:"日志切割设置",modelValue:k(ie),"onUpdate:modelValue":a[7]||(a[7]=e=>S(ie)?ie.value=e:null),area:56},{default:E(()=>[C("div",Le,[C("div",Oe,[a[21]||(a[21]=C("span",{class:"mr-[8px]"},"日志大小",-1)),C("span",null,T(k(pe).size),1)]),C("div",Je,[w(v,{placement:"bottom",width:"200","popper-class":"green-tips-popover",trigger:"hover"},{reference:E(()=>[w(k(x),{modelValue:k(pe).split,"onUpdate:modelValue":a[6]||(a[6]=e=>k(pe).split=e),size:"small",onChange:k(fe)},{default:E(()=>[...a[22]||(a[22]=[b("日志切割",-1)])]),_:1},8,["modelValue","onChange"])]),default:E(()=>[a[23]||(a[23]=C("span",{class:"p-[8px] inline-block"},"当日志文件过大时，读取和搜索时间会增加，同时也会占用存储空间，因此需要对日志进行切割以方便管理和维护。",-1))]),_:1}),C("span",qe,T(k(ce).replace("修改请点击","修改下面配置")),1)]),w(y),C("div",Ie,[w(k(o),{class:"py-2rem -ml-1rem"})])])]),_:1},8,["modelValue"])])}}});export{Be as _};
