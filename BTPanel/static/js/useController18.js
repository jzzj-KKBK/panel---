import{c as e,u as t,_ as a,j as l,h as s,ag as n,K as r,M as u,at as o,o as i,ai as c}from"./utils-lib.js?v=1756369731";import{c as m,p,G as d,H as g,x as v,q as y,v as h,F as f,z as x,C as b,y as _,e as w,B as k,A as j,t as E,M as C,P as V,K as I,al as S,a$ as L,T,D as z,ax as P,a9 as F,a7 as B,j as R,r as U,k as q,g as N,n as H}from"./base-lib.js?v=1756369731";import{_ as G,f as M,p as O}from"./validator.js?v=1756369731";import{_ as A}from"./index.vue_vue_type_script_setup_true_lang20.js?v=1756369731";import{_ as D}from"./index116.js?v=1756369731";import{u as K,S as J}from"./useStore4.js?v=1756369731";import{_ as $}from"./index101.js?v=1756369731";import{p as Q}from"./useController5.js?v=1756369731";import{A as W}from"./index323.js?v=1756369731";import{getSiteErrorLogs as X,getSpringBootLogList as Y,getSpringBootLog as Z,changeSiteLogPath as ee,setPushTask as te,getSiteLogPushStatus as ae,getIpArea as le,getSiteLogs as se,getSiteLogFile as ne}from"./site.js?v=1756369731";const re={class:"h-full"},ue={key:0,class:"mb-[16px]"},oe={class:"flex"},ie={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},ce={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},me=m({__name:"error-log",setup(t,{expose:a}){const{isBindExtranet:l,siteType:s}=K(),{jumpTabEvent:n}=J();return p(st),a({init:st}),(t,a)=>{const r=e,u=d("bt-loading");return g((y(),h("div",re,[v(l)?(y(),h(f,{key:0},["proxy"===v(s)?(y(),h("div",ue,"日志大小："+x(v($e).size),1)):b("",!0),_("div",oe,[w(D,{content:v($e).logs,isHtml:!0,fullScreen:{title:"全屏查看[错误]日志",onRefresh:v(st)},style:{height:"56rem",width:"99.5%"}},null,8,["content","fullScreen"])])],64)):(y(),h("div",ie,[_("div",ce,[a[2]||(a[2]=k(" 请开启 ",-1)),w(r,{class:"mx-[.4rem]",onClick:a[0]||(a[0]=e=>v(n)("mapping"))},{default:j(()=>[...a[1]||(a[1]=[k(" 外网映射 ",-1)])]),_:1}),a[3]||(a[3]=k(" 后查看 ",-1))])]))])),[[u,v(Je)]])}}}),pe={class:"h-full"},de={key:0,class:"flex items-center justify-between pb-1.6rem"},ge={class:"flex items-center"},ve={class:"ml-[8px]"},ye={class:"flex items-center"},he={class:"flex items-center p-[12px]"},fe={key:1,class:"mb-[16px]"},xe={key:2,class:"mt-1rem"},be={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},_e={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},we={class:"p-[20px]"},ke=m({__name:"response-log",setup(n,{expose:r}){const{plugin:u,enterpriseRec:o}=t(),{webserver:i}=E(u.value),{isBindExtranet:c,siteType:m}=K(),{jumpTabEvent:R}=J();return p(St),r({init:St}),(t,n)=>{const r=S,u=L,p=a,E=T,U=$,q=z,N=P,H=e,M=l,O=F,A=B,K=s,J=d("bt-loading");return y(),h("div",pe,[v(c)?(y(),h(f,{key:0},["proxy"!==v(m)?(y(),h("div",de,[g((y(),h("div",ge,["python"!==v(m)?(y(),h(f,{key:0},[w(r,{onChange:v(wt),modelValue:v(dt).alert,"onUpdate:modelValue":n[0]||(n[0]=e=>v(dt).alert=e)},null,8,["onChange","modelValue"]),_("span",ve,[n[14]||(n[14]=k(" 关键字告警 ",-1)),_("span",{class:"!inline-block bt-link",onClick:n[1]||(n[1]=(...e)=>v(Ct)&&v(Ct)(...e))}," [配置] ")]),w(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"})],64)):b("",!0),v(o)?(y(),C(E,{key:1,onChange:v(_t),modelValue:v(dt).showIp,"onUpdate:modelValue":n[2]||(n[2]=e=>v(dt).showIp=e)},{default:j(()=>[_("div",ye,[n[15]||(n[15]=k(" 显示IP归属地信息 ",-1)),w(p,{icon:"icon-ltd",size:16,color:"#9B7E48",class:"ml-[4px]"})])]),_:1},8,["onChange","modelValue"])):b("",!0),"php"===v(m)?(y(),h(f,{key:2},[w(u,{direction:"vertical",class:"!h-2rem !mx-1.6rem"}),w(N,{trigger:"click",placement:"bottom","popper-class":"white-tips-popover",width:"400",visible:v(pt),"onUpdate:visible":n[5]||(n[5]=e=>V(pt)?pt.value=e:null)},{reference:j(()=>[w(q,{type:"default"},{default:j(()=>[...n[17]||(n[17]=[k("更改日志路径",-1)])]),_:1})]),default:j(()=>[_("div",he,[w(U,{placeholder:"请输入日志路径",modelValue:v(mt),"onUpdate:modelValue":n[3]||(n[3]=e=>V(mt)?mt.value=e:null),onIconClick:v(xt),icon:"el-folder-opened"},null,8,["modelValue","onIconClick"]),w(q,{type:"primary",class:"!ml-[8px]",onClick:n[4]||(n[4]=e=>v(bt)())},{default:j(()=>[...n[16]||(n[16]=[k(" 保存 ",-1)])]),_:1})])]),_:1},8,["visible"])],64)):b("",!0)])),[[J,v(Je)]]),w(q,{type:"primary",onClick:n[6]||(n[6]=()=>v(Vt)())},{default:j(()=>[...n[18]||(n[18]=[k("刷新日志",-1)])]),_:1})])):b("",!0),"proxy"===v(m)?(y(),h("div",fe,"日志大小："+x(v(dt).size),1)):b("",!0),g(w(D,{content:v(dt).logs,isHtml:!0,fullScreen:{title:"全屏查看[响应]日志",onRefresh:v(Vt)},style:I({height:"php"===v(m)?"52rem":"56rem",width:"99.5%"})},null,8,["content","fullScreen","style"]),[[J,v(Je)]]),"nginx"===v(i)&&"php"===v(m)?(y(),h("div",xe,[n[19]||(n[19]=k(" * 若网站开启cdn导致日志",-1)),n[20]||(n[20]=_("span",{class:"text-danger"},"来源IP",-1)),n[21]||(n[21]=k("解析错误，可前往[ ",-1)),_("span",{class:"cursor-pointer bt-link",onClick:n[7]||(n[7]=e=>v(Q)("globalSetting"))},"全局设置"),n[22]||(n[22]=k(" ]打开cdn来源IP解析 ",-1))])):b("",!0)],64)):(y(),h("div",be,[_("div",_e,[n[24]||(n[24]=k(" 请开启 ",-1)),w(H,{class:"mx-[.4rem]",onClick:n[8]||(n[8]=e=>v(R)("mapping"))},{default:j(()=>[...n[23]||(n[23]=[k(" 外网映射 ",-1)])]),_:1}),n[25]||(n[25]=k(" 后查看 ",-1))])])),w(K,{title:"关键字告警配置",onConfirm:n[12]||(n[12]=e=>v(jt)(v(ht),"confirm")),onCancel:v(kt),modelValue:v(vt),"onUpdate:modelValue":n[13]||(n[13]=e=>V(vt)?vt.value=e:null),area:46,showFooter:""},{default:j(()=>[_("div",we,[w(A,{"label-position":"right",model:v(ht),rules:v(ft),ref_key:"alertSetFormRef",ref:yt},{default:j(()=>[w(O,{label:"周期",prop:"cycle"},{default:j(()=>[w(M,{modelValue:v(ht).cycle,"onUpdate:modelValue":n[9]||(n[9]=e=>v(ht).cycle=e),type:"number",min:1,width:"24rem","text-type":"分钟"},null,8,["modelValue"])]),_:1}),w(O,{label:"关键字",prop:"keys"},{default:j(()=>[w(M,{modelValue:v(ht).keys,"onUpdate:modelValue":n[10]||(n[10]=e=>v(ht).keys=e),type:"textarea",resize:"none",row:6,width:"24rem"},null,8,["modelValue"])]),_:1}),w(O,{label:"告警方式",prop:"channel"},{default:j(()=>[w(G,{modelValue:v(ht).channel,"onUpdate:modelValue":n[11]||(n[11]=e=>v(ht).channel=e),multiple:!0,limit:["sms"],class:"!w-[24rem]"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),n[26]||(n[26]=_("ul",{class:"mt-[8px] leading-8 text-[1.2rem] list-disc ml-[20px]"},[_("li",null,"检查时只检查间隔时间内的日志内容"),_("li",null,"周期时间请勿设置太小，建议10分钟以上以免导致服务器资源异常")],-1))])]),_:1},8,["onCancel","modelValue"])])}}}),je={key:1,class:"bg-[#7F7F7F] flex items-center justify-center h-full",style:{"min-height":"500px"}},Ee={class:"bg-white px-[48px] py-[16px] text-[#333] flex items-center"},Ce=m({__name:"safe-analysis",setup(t){const{isBindExtranet:a,siteInfo:l}=K(),{jumpTabEvent:s}=J();return(t,n)=>{const r=e;return y(),h("div",null,[v(a)?(y(),C(W,{key:0,type:"site",name:v(l).name},null,8,["name"])):(y(),h("div",je,[_("div",Ee,[n[2]||(n[2]=k(" 请开启 ",-1)),w(r,{class:"mx-[.4rem]",onClick:n[0]||(n[0]=e=>v(s)("mapping"))},{default:j(()=>[...n[1]||(n[1]=[k(" 外网映射 ",-1)])]),_:1}),n[3]||(n[3]=k(" 后查看 ",-1))])]))])}}}),Ve={class:"flex flex-col"},Ie={class:"flex items-center"},Se={class:"mt-[16px]"},Le={class:"p-[12px] w-full flex items-start overflow-y-auto h-full"},Te=["innerHTML"],ze=m({__name:"spring-boot-logs",setup(e,{expose:a}){const{mainHeight:l}=t();return p(ct),a({init:ct}),(e,t)=>{const a=n,r=z,u=s,o=d("bt-loading");return g((y(),h("div",Ve,[_("div",Ie,[t[2]||(t[2]=_("span",null,"日志路径",-1)),w(a,{modelValue:v(Ze).path,"onUpdate:modelValue":t[0]||(t[0]=e=>v(Ze).path=e),options:v(Qe),onChange:v(rt),placeholder:"请选择",class:"!w-[38rem] !mx-[.8rem]"},null,8,["modelValue","options","onChange"])]),_("div",Se,[_("div",null,[w(r,{type:"primary",onClick:v(nt)},{default:j(()=>[...t[3]||(t[3]=[k("刷新日志",-1)])]),_:1},8,["onClick"]),w(r,{type:"default",onClick:v(ot)},{default:j(()=>[...t[4]||(t[4]=[k("实时日志",-1)])]),_:1},8,["onClick"])]),w(D,{title:"全屏查看【项目】日志",content:v(Ze).logs,isHtml:!0,fullScreen:{title:"全屏查看【项目】日志",onRefresh:v(nt)},class:"mt-[16px]",style:I({height:"java"===v(We)?"48rem":"64rem",width:"99.5%"})},null,8,["content","fullScreen","style"])]),w(u,{title:"查看日志",onCancel:v(it),modelValue:v(Xe),"onUpdate:modelValue":t[1]||(t[1]=e=>V(Xe)?Xe.value=e:null),area:["100%","100%"],"close-btn":1},{default:j(()=>[_("div",{ref_key:"logPopupCon",ref:Ye,class:"bg-[#333] text-white w-full h-full",style:I("height: ".concat(v(l),"px;"))},[_("pre",Le,[t[5]||(t[5]=k("\t\t\t\t\t",-1)),_("code",{class:"flex-1 w-full p-0 bg-none whitespace-pre-line text-i text-[#ececec]",innerHTML:v(Ze).logs},null,8,Te),t[6]||(t[6]=k("\n\t\t\t\t",-1))])],4)]),_:1},8,["onCancel","modelValue"])])),[[o,v(Je)]])}}}),Pe=R("SITE-LOGS-STORE",()=>{const{siteType:e,siteInfo:t}=K();return{getErrorLogsEvent:async t=>{try{const{data:a}=await X(t,e.value);return{data:a,status:!0}}catch(a){return{msg:"获取错误日志失败",status:!1}}},getSpringLogEvent:async e=>{try{const{data:t}=await Y(e);return{data:t.data,status:t.status}}catch(t){return{msg:"获取日志失败",status:!1}}},setSpringPathEvent:async e=>{try{const{data:t}=await Z(e);return{status:t.status,msg:t.data}}catch(t){return{msg:"保存路径失败",status:!1}}},saveResLogPathEvent:async e=>{try{const t=await r({loading:"正在保存日志路径，请稍后...",request:ee(e),message:!0});return{status:t.status,msg:t.msg}}catch(t){return{msg:"保存路径失败",status:!1}}},setPushTaskEvent:async e=>{try{const t=await r({loading:"正则处理中，请稍后...",request:te(e),message:!0});return{status:t.status,msg:t.msg}}catch(t){return{status:!1,msg:"推送失败"}}},getLogPushEvent:async()=>{try{return{data:await r({request:ae({sitename:t.value.name}),data:{status:Boolean,"config.cycle":[Number,"cycle"],"config.keys":[Array,"keys"],"config.channel":[String,"channel"]}}),status:!0}}catch(e){return{msg:"获取推送配置失败",status:!1}}},getIpStatusEvent:async()=>{try{return{data:(await r({request:le(),data:{msg:[Number,"msg"]}})).msg,status:!0}}catch(e){return{msg:"获取IP归属地失败",status:!1}}},getResLogEvent:async t=>{try{const a=await se(t,e.value);return{data:a.data,status:a.status}}catch(a){return{msg:"获取日志失败",status:!1}}}}}),{payment:Fe}=t(),{authType:Be}=E(Fe.value),{getErrorLogsEvent:Re,getSpringLogEvent:Ue,setSpringPathEvent:qe,saveResLogPathEvent:Ne,setPushTaskEvent:He,getLogPushEvent:Ge,getIpStatusEvent:Me,getResLogEvent:Oe}=Pe(),{siteType:Ae,siteInfo:De,isBindExtranet:Ke}=K(),Je=U(!1),$e=U({logs:"",size:"0 b"}),Qe=U([]),We=U(""),Xe=U(!1),Ye=U(null),Ze=q({path:"",logs:"",type:"",size:"",isNew:!1,isGunicorn:!1}),et=N(()=>{var e;return(null==(e=De.value)?void 0:e.tabName)||("java"===Ae.value?"projectLog":"response")}),tt=U([{label:"响应日志",name:"response",lazy:!0,render:()=>w(ke,null,null)},{label:"错误日志",name:"error",lazy:!0,render:()=>w(me,null,null)},{label:"日志安全分析",name:"safe",lazy:!0,render:()=>w(Ce,null,null)}]),at=e=>{},lt=()=>{var e,t,a,l;"java"===Ae.value?(tt.value.some(e=>"projectLog"===e.name)||tt.value.unshift({label:"项目日志",name:"projectLog",lazy:!0,render:()=>w(A,null,null)}),"springboot"===(null==(t=null==(e=De.value)?void 0:e.project_config)?void 0:t.java_type)?tt.value.some(e=>"springbootLog"===e.name)||tt.value.push({label:"springBoot日志",name:"springbootLog",lazy:!0,render:()=>w(ze,null,null)}):tt.value=tt.value.filter(e=>"springbootLog"!==e.name)):tt.value=tt.value.filter(e=>"projectLog"!==e.name&&"springbootLog"!==e.name);["php","proxy","html"].includes(Ae.value)?Ke.value=!0:Ke.value=!!(null==(l=null==(a=De.value)?void 0:a.project_config)?void 0:l.bind_extranet)},st=async()=>{var e,t;if(!Ke.value)return;const a=De.value.name,l=Ae.value,s={proxy:{site_name:a,type:"error"},default:{siteName:a}};try{Je.value=!0;const a=await Re(s[l]||s.default);return"proxy"===l&&($e.value.size=a.data.size||"0 b"),$e.value.logs=(null==(e=a.data)?void 0:e.logs)||(null==(t=a.data)?void 0:t.msg)||"暂无日志信息",a}catch(n){return o(n),{msg:"获取错误日志失败",status:!1}}finally{Je.value=!1}},nt=async()=>{Je.value=!0;try{const e={project_name:De.value.name},{data:t,status:a}=await Ue(e);a&&(Qe.value=t.map(e=>({label:e,value:e})),Ze.logs="正在获取日志",Ze.path=(null==t?void 0:t[0])||"",rt())}catch(e){}finally{Je.value=!1}},rt=async e=>{try{if(!Ze.path)return Ze.logs="暂未在SpringBoot框架中查找到日志配置信息",!1;const e=await qe({log_file:Ze.path});return e.status||u.error(e.msg),Ze.logs=e.msg||"获取日志失败",e}catch(t){return{msg:"保存路径失败",status:!1}}};let ut=null;const ot=()=>{Xe.value=!0,H(()=>{Ye.value&&(Ye.value.scrollTop=Ye.value.scrollHeight)}),ut&&clearInterval(ut),ut=setInterval(()=>{nt()},2e3)},it=()=>{Xe.value=!1,clearInterval(ut),ut=null},ct=()=>{var e,t;We.value="java",Ze.type=(null==(e=De.value.project_config)?void 0:e.loglevel)||"",Ze.isGunicorn="gunicorn"===(null==(t=De.value.project_config)?void 0:t.stype),nt()},mt=U(""),pt=U(!1),dt=q({alert:!1,showIp:!1,ipData:0,logs:"",size:"0 b"}),gt=U(!1),vt=U(!1),yt=U(),ht=q({cycle:0,keys:"",channel:[]}),ft=q({cycle:[{required:!0,message:"请输入周期",trigger:"blur"}],keys:[{required:!0,message:"请输入关键字",trigger:"blur"}],channel:[{required:!0,message:"请选择告警方式",trigger:"blur"}]}),xt=()=>{M({type:"dir",path:mt.value,change:e=>{mt.value=e,setTimeout(()=>{pt.value=!0},0)}})},bt=async(e={site_name:De.value.name,log_path:mt.value})=>{await i({title:"保存日志路径",content:"是否保存日志路径[".concat(mt.value,"]")});(await Ne({site_name:De.value.name,log_path:mt.value})).status&&(Vt(),It(),pt.value=!1)},_t=async()=>{"ltd"!==Be.value?(dt.showIp=!1,O({disablePro:!0,sourceId:184})):Vt()},wt=async e=>{gt.value=!0,e?vt.value=!0:jt({},"switch")},kt=()=>{gt.value&&(dt.alert=!dt.alert,gt.value=!1)},jt=async(e,t)=>{try{vt.value&&await yt.value.validate();let a={sitename:De.value.name};"switch"!==t&&(gt.value||delete a.sitename,a.channel=e.channel.filter(e=>""!==e).join(","),a.cycle=e.cycle,a.keys=JSON.stringify(c(e.keys)?e.keys.split(","):e.keys));const l=await He(a);return l.status&&Et(),l.status}catch(a){return!1}},Et=async()=>{try{const e=await Ge();let t={};if(e.status){dt.alert=e.data.status;const{cycle:a,keys:l,channel:s}=e.data;t={cycle:a,keys:l,channel:s.split(","),status:e.status}}else dt.alert=!1;return Object.assign(ht,t),{data:t,status:e.status}}catch(e){return{msg:"获取告警配置失败",status:!1}}},Ct=()=>{vt.value=!0,Et()},Vt=async(e=De.value.name,t=Ae.value)=>{"ltd"!==Be.value&&(dt.showIp=!1);const a={proxy:{site_name:e,type:"access"},default:{siteName:e,ip_area:Number(dt.showIp)}};try{Je.value=!0;const e=await Oe(a[t]||a.default);return"proxy"===t?(dt.logs=e.data.msg||"暂无日志信息",dt.size=e.data.size||"0 b"):dt.logs=e.data.msg||"暂无日志信息",e}catch(l){return o(l),{msg:"获取日志失败",status:!1}}finally{Je.value=!1}},It=()=>{r({request:ne({siteName:De.value.name}),data:{log_file:String,status:Boolean,msg:String},success:e=>{mt.value=e.log_file,e.status||u.error(e.msg)}})},St=async()=>{Ke.value&&(await(async()=>{try{const e=await Me();dt.showIp=1===e.data}catch(e){return{msg:"获取IP归属地失败",status:!1}}})(),"python"!==Ae.value&&await Et(),await Vt(),It())};export{ke as _,tt as a,me as b,lt as i,at as o,et as t};
