import{G as e,o as a,l as t,M as s,iY as l,a6 as r,iZ as o,v as n,e as i}from"./utils-lib.js?v=1756369731";import{k as m,b as c,h as d,f as u}from"./form-item.js?v=1756369731";import{a as p}from"./column.js?v=1756369731";import{a as v,b as g}from"./index63.js?v=1756369731";import{c as y,r as b,e as _,T as f,B as h,ac as j,ag as w,af as I,q as x,v as q,x as P,i as M}from"./base-lib.js?v=1756369731";import{_ as S}from"./index103.js?v=1756369731";import"./__commonjsHelpers__.js?v=1756369731";import"./index104.js?v=1756369731";import"./useController6.js?v=1756369731";import"./site.js?v=1756369731";import"./validator.js?v=1756369731";import"./useStore4.js?v=1756369731";const B={class:"p-[2rem] node-master-mysql-add-form"};const k=i(y({__name:"add-form",props:{compData:{default:()=>({panel_address:""})}},setup(i,{expose:y}){var k;const{mysqlRowData:z,isRefreshList:A}=v(),C=[{label:"面板自动同步",value:"auto",desc:"通过主库面板连接从库面板进行导入导出数据，简单快捷，建议内网机器使用"},{label:"手动同步到从库",value:"manual",desc:"通过主库面板备份，手动将备份文件上传至从库导入后进行数据还原后同步，大于1G数据建议使用此方法同步"}],D=b({node_id:"",master_ip:(null==(k=null==i?void 0:i.compData)?void 0:k.panel_address)||"",slave_ip:"",err_code:["1062"],sync_type:"auto",db_name:""}),{BtForm:T,validate:E,param:V,submit:G}=e({data:D.value,options:[m("选择从库节点","node_id",z.value,{attrs:{placeholder:"请选择从库节点",class:"!w-[45rem]",onChange:e=>{var a;V.value.slave_ip=(null==(a=z.value.find(a=>a.value===e))?void 0:a.remarks)||""}},rules:[{required:!0,message:"请选择从库节点",trigger:"change"}]}),c("主库IP地址","master_ip",{attrs:{placeholder:"请输入主库IP地址，如：192.168.1.100",class:"!w-[45rem]"},rules:[{required:!0,message:"请输入主库IP地址",trigger:["blur","change"]},{pattern:/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,message:"请输入正确的IP地址格式",trigger:["blur","change"]}]}),c("从库IP地址","slave_ip",{attrs:{placeholder:"请输入从库IP地址，如：192.168.1.101",class:"!w-[45rem]"},rules:[{required:!0,message:"请输入从库IP地址",trigger:["blur","change"]},{pattern:/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,message:"请输入正确的IP地址格式",trigger:["blur","change"]}]}),d(" ",()=>_(j,{modelValue:V.value.err_code,"onUpdate:modelValue":e=>V.value.err_code=e,class:"mb-[1.2rem]"},{default:()=>[_(f,{value:"1062",key:"1062"},{default:()=>[_("span",null,[h("跳过1062错误")]),_("div",{class:"err_code_desc"},[h("跳过主键或唯一键冲突错误")])]})]}),"err_code"),(()=>{const{BtTable:e,BtPage:a,BtSearch:t}=r({request:async e=>{e.limit=50;const{data:a}=await o(e);return a.data[0].keys_scopes_status=!0,{data:a.data,total:a.page.total_count}},columns:[p({key:"id"}),{label:"数据库名称",prop:"name"},{label:"数据库大小",prop:"size",render:e=>_("span",null,[n(e.size)])},{label:"数据库引擎",prop:"type"}]});return d("同步数据库",()=>_("div",{class:"w-[94.2%]"},[_(S,null,{"header-right":()=>_(t,{placeholder:"请输入数据库名称",class:"!w-[20rem]"},null),content:()=>_(e,{height:"200px",onSelectionChange:async e=>{try{V.value.db_name=e.map(e=>e.name).join(","),V.value.db_type=e.map(e=>e.type).join(","),await E()}catch(a){}}},null),"footer-right":()=>_(a,{layout:"prev, pager, next, total, jumper","page-size":50},null)})]),"db_name",{class:"node-master-mysql-db-table",rules:[{required:!0,message:"请选择要同步的数据库",trigger:"change"}]})})(),u(" ",[{content:"添加后仅同步选中的数据库数据，如需新增数据库需删除主从重新配置"}]),d("首次同步方式",()=>{let e;return _(I,{modelValue:V.value.sync_type,"onUpdate:modelValue":e=>V.value.sync_type=e},"function"==typeof(a=e=C.map(e=>_(w,{class:"mt-[1rem]",value:e.value,key:e.value,style:{height:"auto",lineHeight:"1",alignItems:"flex-start"}},{default:()=>[_("span",{class:"radio-label"},[e.label]),_("div",{class:"radio-desc mt-[1rem] mb-[1rem] w-[43rem]",style:{whiteSpace:"normal",lineHeight:"1.5"}},[e.desc])]})))||"[object Object]"===Object.prototype.toString.call(a)&&!M(a)?e:{default:()=>[e]});var a},"sync_type"),u("",[{content:"仅支持mysql-5.7+版本（不支持mariadb）"}])],submit:async(e,r,o)=>{try{await r(),await a({icon:"warning-filled",title:"提示",content:"首次配置将会重启数据库，如从库有同名数据库将会进行数据覆盖，建议空闲时间配置，是否继续？"})}catch(i){return!1}if(e.value.db_type.includes("MyISAM"))try{await new Promise((e,a)=>{t({title:"MyISAM 引擎警告",area:50,showFooter:!0,component:()=>_("div",{class:"p-[2rem] text-[1.4rem]"},[_("div",{style:"color:#e53e3e;margin-bottom:8px;font-size: 1.4rem;"},[h("检测到选中的数据库包含 MyISAM 存储引擎的表，可能存在以下风险：")]),_("ul",{style:"margin-bottom:16px;list-style: disc;padding-left: 2rem;"},[_("li",null,[h("数据不一致：MyISAM 不支持事务，同步过程中可能出现数据不完整")]),_("li",null,[h("主从中断：表级锁定机制在高并发时内容易导致同步失败")]),_("li",null,[h("错误频发：需要设置错误跳过机制才能正常运行")])]),_("div",{style:"margin-bottom:2rem"},[_("div",{style:"margin-bottom:1rem"},[h("建议方案：")]),_("div",{style:"color:#22c55e; font-size: 1.4rem;margin-bottom:1rem"},[h("【推荐】转换为 InnoDB: ALTER TABLE table_name ENGINE=InnoDB")]),_("div",{style:"color:#2563eb; font-size: 1.4rem;"},[h("【备选】继续使用并设置错误跳过码（如: 1062）")])]),_("div",null,[h("确定要继续选择这些数据库吗？")])]),confirmText:"继续添加",cancelText:"取消",onConfirm:()=>(e(!0),!0),onCancel:()=>(a(),!1)})})}catch(m){return!1}const n=s.load("正在添加主从，请稍后...");try{const a=await l(e.value);return a.status?(s.success("创建成功"),g(e.value.slave_ip),!0):(s.error(a.msg),!1)}catch(i){return s.error("创建失败，请重试"),!1}finally{A.value=!0,n.close()}}});return y({validate:E,onConfirm:G,formData:V}),(e,a)=>(x(),q("div",B,[_(P(T))]))}}),[["__scopeId","data-v-29a45000"]]);export{k as default};
